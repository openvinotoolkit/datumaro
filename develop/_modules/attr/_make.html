
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>attr._make &#8212; Datumaro 1.10.0.dev0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=8b7c274f" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=9b3985ad"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/attr/_make';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/datumaro-logo.png" class="logo__image only-light" alt="Datumaro 1.10.0.dev0 documentation - Home"/>
    <script>document.write(`<img src="../../_static/datumaro-logo.png" class="logo__image only-dark" alt="Datumaro 1.10.0.dev0 documentation - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../docs/index.html">
                        Docs
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/openvinotoolkit/datumaro" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/github_icon.png" class="icon-link-image" alt="GitHub"/></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../docs/index.html">
                        Docs
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/openvinotoolkit/datumaro" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><img src="../../_static/github_icon.png" class="icon-link-image" alt="GitHub"/></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">attr._make</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for attr._make</h1><div class="highlight"><pre>
<span></span><span class="c1"># SPDX-License-Identifier: MIT</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">typing</span>

<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>

<span class="c1"># We need to import _compat itself in addition to the _compat members to avoid</span>
<span class="c1"># having the thread-local in the globals here.</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_compat</span><span class="p">,</span> <span class="n">_config</span><span class="p">,</span> <span class="n">setters</span>
<span class="kn">from</span> <span class="nn">._compat</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PY_3_8_PLUS</span><span class="p">,</span>
    <span class="n">PY_3_10_PLUS</span><span class="p">,</span>
    <span class="n">PY_3_11_PLUS</span><span class="p">,</span>
    <span class="n">_AnnotationExtractor</span><span class="p">,</span>
    <span class="n">_get_annotations</span><span class="p">,</span>
    <span class="n">get_generic_base</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DefaultAlreadySetError</span><span class="p">,</span>
    <span class="n">FrozenInstanceError</span><span class="p">,</span>
    <span class="n">NotAnAttrsClassError</span><span class="p">,</span>
    <span class="n">UnannotatedAttributeError</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># This is used at least twice, so cache it here.</span>
<span class="n">_OBJ_SETATTR</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span>
<span class="n">_INIT_FACTORY_PAT</span> <span class="o">=</span> <span class="s2">&quot;__attr_factory_</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="n">_CLASSVAR_PREFIXES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;typing.ClassVar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;t.ClassVar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ClassVar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;typing_extensions.ClassVar&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># we don&#39;t use a double-underscore prefix because that triggers</span>
<span class="c1"># name mangling when trying to create a slot for the field</span>
<span class="c1"># (when slots=True)</span>
<span class="n">_HASH_CACHE_FIELD</span> <span class="o">=</span> <span class="s2">&quot;_attrs_cached_hash&quot;</span>

<span class="n">_EMPTY_METADATA_SINGLETON</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MappingProxyType</span><span class="p">({})</span>

<span class="c1"># Unique object for unequivocal getattr() defaults.</span>
<span class="n">_SENTINEL</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<span class="n">_DEFAULT_ON_SETATTR</span> <span class="o">=</span> <span class="n">setters</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">setters</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span> <span class="n">setters</span><span class="o">.</span><span class="n">validate</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_Nothing</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sentinel to indicate the lack of a value when `None` is ambiguous.</span>

<span class="sd">    If extending attrs, you can use ``typing.Literal[NOTHING]`` to show</span>
<span class="sd">    that a value may be ``NOTHING``.</span>

<span class="sd">    .. versionchanged:: 21.1.0 ``bool(NOTHING)`` is now False.</span>
<span class="sd">    .. versionchanged:: 22.2.0 ``NOTHING`` is now an ``enum.Enum`` variant.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">NOTHING</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">auto</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;NOTHING&quot;</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="n">NOTHING</span> <span class="o">=</span> <span class="n">_Nothing</span><span class="o">.</span><span class="n">NOTHING</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Sentinel to indicate the lack of a value when `None` is ambiguous.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">_CacheHashWrapper</span><span class="p">(</span><span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An integer subclass that pickles / copies as None</span>

<span class="sd">    This is used for non-slots classes with ``cache_hash=True``, to avoid</span>
<span class="sd">    serializing a potentially (even likely) invalid hash value. Since `None`</span>
<span class="sd">    is the default value for uncalculated hashes, whenever this is copied,</span>
<span class="sd">    the copy&#39;s value for the hash should automatically reset.</span>

<span class="sd">    See GH #613 for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_none_constructor</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">_args</span><span class="o">=</span><span class="p">()):</span>  <span class="c1"># noqa: B008</span>
        <span class="k">return</span> <span class="n">_none_constructor</span><span class="p">,</span> <span class="n">_args</span>


<div class="viewcode-block" id="attrib">
<a class="viewcode-back" href="../../docs/reference/_autosummary/datumaro.components.merge.intersect_merge.html#datumaro.components.annotations.matcher.attrib">[docs]</a>
<span class="k">def</span> <span class="nf">attrib</span><span class="p">(</span>
    <span class="n">default</span><span class="o">=</span><span class="n">NOTHING</span><span class="p">,</span>
    <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">factory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">kw_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">eq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">on_setattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new field / attribute on a class.</span>

<span class="sd">    Identical to `attrs.field`, except it&#39;s not keyword-only.</span>

<span class="sd">    Consider using `attrs.field` in new code (``attr.ib`` will *never* go away,</span>
<span class="sd">    though).</span>

<span class="sd">    ..  warning::</span>

<span class="sd">        Does **nothing** unless the class is also decorated with</span>
<span class="sd">        `attr.s` (or similar)!</span>


<span class="sd">    .. versionadded:: 15.2.0 *convert*</span>
<span class="sd">    .. versionadded:: 16.3.0 *metadata*</span>
<span class="sd">    .. versionchanged:: 17.1.0 *validator* can be a ``list`` now.</span>
<span class="sd">    .. versionchanged:: 17.1.0</span>
<span class="sd">       *hash* is `None` and therefore mirrors *eq* by default.</span>
<span class="sd">    .. versionadded:: 17.3.0 *type*</span>
<span class="sd">    .. deprecated:: 17.4.0 *convert*</span>
<span class="sd">    .. versionadded:: 17.4.0</span>
<span class="sd">       *converter* as a replacement for the deprecated *convert* to achieve</span>
<span class="sd">       consistency with other noun-based arguments.</span>
<span class="sd">    .. versionadded:: 18.1.0</span>
<span class="sd">       ``factory=f`` is syntactic sugar for ``default=attr.Factory(f)``.</span>
<span class="sd">    .. versionadded:: 18.2.0 *kw_only*</span>
<span class="sd">    .. versionchanged:: 19.2.0 *convert* keyword argument removed.</span>
<span class="sd">    .. versionchanged:: 19.2.0 *repr* also accepts a custom callable.</span>
<span class="sd">    .. deprecated:: 19.2.0 *cmp* Removal on or after 2021-06-01.</span>
<span class="sd">    .. versionadded:: 19.2.0 *eq* and *order*</span>
<span class="sd">    .. versionadded:: 20.1.0 *on_setattr*</span>
<span class="sd">    .. versionchanged:: 20.3.0 *kw_only* backported to Python 2</span>
<span class="sd">    .. versionchanged:: 21.1.0</span>
<span class="sd">       *eq*, *order*, and *cmp* also accept a custom callable</span>
<span class="sd">    .. versionchanged:: 21.1.0 *cmp* undeprecated</span>
<span class="sd">    .. versionadded:: 22.2.0 *alias*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eq</span><span class="p">,</span> <span class="n">eq_key</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">order_key</span> <span class="o">=</span> <span class="n">_determine_attrib_eq_order</span><span class="p">(</span>
        <span class="n">cmp</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid value for hash.  Must be True, False, or None.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTHING</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The `default` and `factory` arguments are mutually exclusive.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">factory</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The `factory` argument must be a callable.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Apply syntactic sugar by auto-wrapping.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on_setattr</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">on_setattr</span> <span class="o">=</span> <span class="n">setters</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">*</span><span class="n">on_setattr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">validator</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">validator</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">converter</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">converter</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="o">*</span><span class="n">converter</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_CountingAttr</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="n">validator</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="nb">repr</span><span class="p">,</span>
        <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">hash</span><span class="o">=</span><span class="nb">hash</span><span class="p">,</span>
        <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
        <span class="n">converter</span><span class="o">=</span><span class="n">converter</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
        <span class="n">kw_only</span><span class="o">=</span><span class="n">kw_only</span><span class="p">,</span>
        <span class="n">eq</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span>
        <span class="n">eq_key</span><span class="o">=</span><span class="n">eq_key</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
        <span class="n">order_key</span><span class="o">=</span><span class="n">order_key</span><span class="p">,</span>
        <span class="n">on_setattr</span><span class="o">=</span><span class="n">on_setattr</span><span class="p">,</span>
        <span class="n">alias</span><span class="o">=</span><span class="n">alias</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_compile_and_eval</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">locs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate the script with the given global (globs) and local (locs)</span>
<span class="sd">    variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bytecode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">)</span>
    <span class="nb">eval</span><span class="p">(</span><span class="n">bytecode</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">locs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_method</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the method with the script given and return the method object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="nb">locals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">locals</span>

    <span class="c1"># In order of debuggers like PDB being able to step through the code,</span>
    <span class="c1"># we add a fake linecache entry.</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">base_filename</span> <span class="o">=</span> <span class="n">filename</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">linecache_tuple</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">script</span><span class="p">),</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">script</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">filename</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">old_val</span> <span class="o">=</span> <span class="n">linecache</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">linecache_tuple</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_val</span> <span class="o">==</span> <span class="n">linecache_tuple</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">_compile_and_eval</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">locs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_make_attr_tuple_class</span><span class="p">(</span><span class="n">cls_name</span><span class="p">,</span> <span class="n">attr_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a tuple subclass to hold `Attribute`s for an `attrs` class.</span>

<span class="sd">    The subclass is a bare tuple with properties for names.</span>

<span class="sd">    class MyClassAttributes(tuple):</span>
<span class="sd">        __slots__ = ()</span>
<span class="sd">        x = property(itemgetter(0))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attr_class_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cls_name</span><span class="si">}</span><span class="s2">Attributes&quot;</span>
    <span class="n">attr_class_template</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;class </span><span class="si">{</span><span class="n">attr_class_name</span><span class="si">}</span><span class="s2">(tuple):&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    __slots__ = ()&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">attr_names</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">attr_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attr_names</span><span class="p">):</span>
            <span class="n">attr_class_template</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2"> = _attrs_property(_attrs_itemgetter(</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">))&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attr_class_template</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    pass&quot;</span><span class="p">)</span>
    <span class="n">globs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_attrs_itemgetter&quot;</span><span class="p">:</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="s2">&quot;_attrs_property&quot;</span><span class="p">:</span> <span class="nb">property</span><span class="p">}</span>
    <span class="n">_compile_and_eval</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attr_class_template</span><span class="p">),</span> <span class="n">globs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">globs</span><span class="p">[</span><span class="n">attr_class_name</span><span class="p">]</span>


<span class="c1"># Tuple class for extracted attributes from a class definition.</span>
<span class="c1"># `base_attrs` is a subset of `attrs`.</span>
<span class="n">_Attributes</span> <span class="o">=</span> <span class="n">_make_attr_tuple_class</span><span class="p">(</span>
    <span class="s2">&quot;_Attributes&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="c1"># all attributes to build dunder methods for</span>
        <span class="s2">&quot;attrs&quot;</span><span class="p">,</span>
        <span class="c1"># attributes that have been inherited</span>
        <span class="s2">&quot;base_attrs&quot;</span><span class="p">,</span>
        <span class="c1"># map inherited attributes to their originating classes</span>
        <span class="s2">&quot;base_attrs_map&quot;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_class_var</span><span class="p">(</span><span class="n">annot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether *annot* is a typing.ClassVar.</span>

<span class="sd">    The string comparison hack is used to avoid evaluating all string</span>
<span class="sd">    annotations which would put attrs-based classes at a performance</span>
<span class="sd">    disadvantage compared to plain old classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annot</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">annot</span><span class="p">)</span>

    <span class="c1"># Annotation can be quoted.</span>
    <span class="k">if</span> <span class="n">annot</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">annot</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)):</span>
        <span class="n">annot</span> <span class="o">=</span> <span class="n">annot</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">annot</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">_CLASSVAR_PREFIXES</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_has_own_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrib_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether *cls* defines *attrib_name* (and doesn&#39;t just inherit it).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">attrib_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>


<span class="k">def</span> <span class="nf">_collect_base_attrs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">taken_attr_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect attr.ibs from base classes of *cls*, except *taken_attr_names*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_attrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">base_attr_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># A dictionary of base attrs to their classes.</span>

    <span class="c1"># Traverse the MRO and collect attributes.</span>
    <span class="k">for</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base_cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">inherited</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">taken_attr_names</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">inherited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PLW2901</span>
            <span class="n">base_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">base_attr_map</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_cls</span>

    <span class="c1"># For each name, only keep the freshest definition i.e. the furthest at the</span>
    <span class="c1"># back.  base_attr_map is fine because it gets overwritten with every new</span>
    <span class="c1"># instance.</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">base_attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">filtered</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">base_attr_map</span>


<span class="k">def</span> <span class="nf">_collect_base_attrs_broken</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">taken_attr_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collect attr.ibs from base classes of *cls*, except *taken_attr_names*.</span>

<span class="sd">    N.B. *taken_attr_names* will be mutated.</span>

<span class="sd">    Adhere to the old incorrect behavior.</span>

<span class="sd">    Notably it collects from the front and considers inherited attributes which</span>
<span class="sd">    leads to the buggy behavior reported in #428.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_attrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">base_attr_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># A dictionary of base attrs to their classes.</span>

    <span class="c1"># Traverse the MRO and collect attributes.</span>
    <span class="k">for</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base_cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">taken_attr_names</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">inherited</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: PLW2901</span>
            <span class="n">taken_attr_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">base_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">base_attr_map</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_cls</span>

    <span class="k">return</span> <span class="n">base_attrs</span><span class="p">,</span> <span class="n">base_attr_map</span>


<span class="k">def</span> <span class="nf">_transform_attrs</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">these</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="p">,</span> <span class="n">kw_only</span><span class="p">,</span> <span class="n">collect_by_mro</span><span class="p">,</span> <span class="n">field_transformer</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform all `_CountingAttr`s on a class into `Attribute`s.</span>

<span class="sd">    If *these* is passed, use that and don&#39;t look for them on the class.</span>

<span class="sd">    If *collect_by_mro* is True, collect them in the correct MRO order,</span>
<span class="sd">    otherwise use the old -- incorrect -- order.  See #428.</span>

<span class="sd">    Return an `_Attributes`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
    <span class="n">anns</span> <span class="o">=</span> <span class="n">_get_annotations</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">these</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ca_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">these</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">auto_attribs</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ca_names</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">_CountingAttr</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">ca_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">annot_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">anns</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">_is_class_var</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">annot_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">NOTHING</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_CountingAttr</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">NOTHING</span> <span class="k">else</span> <span class="n">attrib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
            <span class="n">ca_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

        <span class="n">unannotated</span> <span class="o">=</span> <span class="n">ca_names</span> <span class="o">-</span> <span class="n">annot_names</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unannotated</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnannotatedAttributeError</span><span class="p">(</span>
                <span class="s2">&quot;The following `attr.ib`s lack a type annotation: &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="nb">sorted</span><span class="p">(</span><span class="n">unannotated</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">cd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ca_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">_CountingAttr</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">counter</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">own_attrs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Attribute</span><span class="o">.</span><span class="n">from_counting_attr</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">ca</span><span class="o">=</span><span class="n">ca</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">anns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">ca</span> <span class="ow">in</span> <span class="n">ca_list</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">collect_by_mro</span><span class="p">:</span>
        <span class="n">base_attrs</span><span class="p">,</span> <span class="n">base_attr_map</span> <span class="o">=</span> <span class="n">_collect_base_attrs</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">own_attrs</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_attrs</span><span class="p">,</span> <span class="n">base_attr_map</span> <span class="o">=</span> <span class="n">_collect_base_attrs_broken</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">own_attrs</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">kw_only</span><span class="p">:</span>
        <span class="n">own_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">own_attrs</span><span class="p">]</span>
        <span class="n">base_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">kw_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">base_attrs</span><span class="p">]</span>

    <span class="n">attrs</span> <span class="o">=</span> <span class="n">base_attrs</span> <span class="o">+</span> <span class="n">own_attrs</span>

    <span class="c1"># Mandatory vs non-mandatory attr order only matters when they are part of</span>
    <span class="c1"># the __init__ signature and when they aren&#39;t kw_only (which are moved to</span>
    <span class="c1"># the end and can be mandatory or non-mandatory in any order, as they will</span>
    <span class="c1"># be specified as keyword args anyway). Check the order of those attrs:</span>
    <span class="n">had_default</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">kw_only</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">had_default</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">NOTHING</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No mandatory attributes allowed after an attribute with a default value or factory.  Attribute in question: </span><span class="si">{</span><span class="n">a</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">had_default</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTHING</span><span class="p">:</span>
            <span class="n">had_default</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">field_transformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">field_transformer</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

    <span class="c1"># Resolve default field alias after executing field_transformer.</span>
    <span class="c1"># This allows field_transformer to differentiate between explicit vs</span>
    <span class="c1"># default aliases and supply their own defaults.</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">a</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="n">_default_init_alias_for</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">alias</span> <span class="k">else</span> <span class="n">a</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span>
    <span class="p">]</span>

    <span class="c1"># Create AttrsClass *after* applying the field_transformer since it may</span>
    <span class="c1"># add or remove attributes!</span>
    <span class="n">attr_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">]</span>
    <span class="n">AttrsClass</span> <span class="o">=</span> <span class="n">_make_attr_tuple_class</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">attr_names</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_Attributes</span><span class="p">((</span><span class="n">AttrsClass</span><span class="p">(</span><span class="n">attrs</span><span class="p">),</span> <span class="n">base_attrs</span><span class="p">,</span> <span class="n">base_attr_map</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_make_cached_property_getattr</span><span class="p">(</span><span class="n">cached_properties</span><span class="p">,</span> <span class="n">original_getattr</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># Wrapped to get `__class__` into closure cell for super()</span>
        <span class="c1"># (It will be replaced with the newly constructed class after construction).</span>
        <span class="s2">&quot;def wrapper(_cls):&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    __class__ = _cls&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    def __getattr__(self, item, cached_properties=cached_properties, original_getattr=original_getattr, _cached_setattr_get=_cached_setattr_get):&quot;</span><span class="p">,</span>
        <span class="s2">&quot;         func = cached_properties.get(item)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;         if func is not None:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;              result = func(self)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;              _setter = _cached_setattr_get(self)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;              _setter(item, result)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;              return result&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">original_getattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;         return original_getattr(self, item)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;         try:&quot;</span><span class="p">,</span>
                <span class="s2">&quot;             return super().__getattribute__(item)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;         except AttributeError:&quot;</span><span class="p">,</span>
                <span class="s2">&quot;             if not hasattr(super(), &#39;__getattr__&#39;):&quot;</span><span class="p">,</span>
                <span class="s2">&quot;                 raise&quot;</span><span class="p">,</span>
                <span class="s2">&quot;             return super().__getattr__(item)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;         original_error = f</span><span class="se">\&quot;</span><span class="s2">&#39;</span><span class="si">{self.__class__.__name__}</span><span class="s2">&#39; object has no attribute &#39;</span><span class="si">{item}</span><span class="s2">&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;         raise AttributeError(original_error)&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;    return __getattr__&quot;</span><span class="p">,</span>
            <span class="s2">&quot;__getattr__ = wrapper(_cls)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">unique_filename</span> <span class="o">=</span> <span class="n">_generate_unique_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;getattr&quot;</span><span class="p">)</span>

    <span class="n">glob</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cached_properties&quot;</span><span class="p">:</span> <span class="n">cached_properties</span><span class="p">,</span>
        <span class="s2">&quot;_cached_setattr_get&quot;</span><span class="p">:</span> <span class="n">_OBJ_SETATTR</span><span class="o">.</span><span class="fm">__get__</span><span class="p">,</span>
        <span class="s2">&quot;original_getattr&quot;</span><span class="p">:</span> <span class="n">original_getattr</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">_make_method</span><span class="p">(</span>
        <span class="s2">&quot;__getattr__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span>
        <span class="n">unique_filename</span><span class="p">,</span>
        <span class="n">glob</span><span class="p">,</span>
        <span class="nb">locals</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;_cls&quot;</span><span class="p">:</span> <span class="bp">cls</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_frozen_setattrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attached to frozen classes as __setattr__.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;__cause__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__context__&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__traceback__&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="ne">BaseException</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">raise</span> <span class="n">FrozenInstanceError</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_frozen_delattrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attached to frozen classes as __delattr__.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="n">FrozenInstanceError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">_ClassBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iteratively build *one* class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;_attr_names&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_attrs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_base_attr_map&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_base_names&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_cache_hash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_cls&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_cls_dict&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_delete_attribs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_frozen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_has_pre_init&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_pre_init_has_args&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_has_post_init&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_is_exc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_on_setattr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_slots&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_weakref_slot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_wrote_own_setattr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_has_custom_setattr&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">these</span><span class="p">,</span>
        <span class="n">slots</span><span class="p">,</span>
        <span class="n">frozen</span><span class="p">,</span>
        <span class="n">weakref_slot</span><span class="p">,</span>
        <span class="n">getstate_setstate</span><span class="p">,</span>
        <span class="n">auto_attribs</span><span class="p">,</span>
        <span class="n">kw_only</span><span class="p">,</span>
        <span class="n">cache_hash</span><span class="p">,</span>
        <span class="n">is_exc</span><span class="p">,</span>
        <span class="n">collect_by_mro</span><span class="p">,</span>
        <span class="n">on_setattr</span><span class="p">,</span>
        <span class="n">has_custom_setattr</span><span class="p">,</span>
        <span class="n">field_transformer</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">attrs</span><span class="p">,</span> <span class="n">base_attrs</span><span class="p">,</span> <span class="n">base_map</span> <span class="o">=</span> <span class="n">_transform_attrs</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">these</span><span class="p">,</span>
            <span class="n">auto_attribs</span><span class="p">,</span>
            <span class="n">kw_only</span><span class="p">,</span>
            <span class="n">collect_by_mro</span><span class="p">,</span>
            <span class="n">field_transformer</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span> <span class="k">if</span> <span class="n">slots</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span> <span class="o">=</span> <span class="n">attrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">base_attrs</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_attr_map</span> <span class="o">=</span> <span class="n">base_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attr_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span> <span class="o">=</span> <span class="n">slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span> <span class="o">=</span> <span class="n">frozen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weakref_slot</span> <span class="o">=</span> <span class="n">weakref_slot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache_hash</span> <span class="o">=</span> <span class="n">cache_hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_pre_init</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_pre_init__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pre_init_has_args</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_pre_init</span><span class="p">:</span>
            <span class="c1"># Check if the pre init method has more arguments than just `self`</span>
            <span class="c1"># We want to pass arguments if pre init expects arguments</span>
            <span class="n">pre_init_func</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__attrs_pre_init__</span>
            <span class="n">pre_init_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">pre_init_func</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pre_init_has_args</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pre_init_signature</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_post_init</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_post_init__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_attribs</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">these</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_exc</span> <span class="o">=</span> <span class="n">is_exc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_on_setattr</span> <span class="o">=</span> <span class="n">on_setattr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_custom_setattr</span> <span class="o">=</span> <span class="n">has_custom_setattr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrote_own_setattr</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span>

        <span class="k">if</span> <span class="n">frozen</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__setattr__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_frozen_setattrs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__delattr__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_frozen_delattrs</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_wrote_own_setattr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">on_setattr</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">_DEFAULT_ON_SETATTR</span><span class="p">,</span>
            <span class="n">setters</span><span class="o">.</span><span class="n">validate</span><span class="p">,</span>
            <span class="n">setters</span><span class="o">.</span><span class="n">convert</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">has_validator</span> <span class="o">=</span> <span class="n">has_converter</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">validator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">has_validator</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">has_converter</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">has_validator</span> <span class="ow">and</span> <span class="n">has_converter</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">on_setattr</span> <span class="o">==</span> <span class="n">_DEFAULT_ON_SETATTR</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">has_validator</span> <span class="ow">or</span> <span class="n">has_converter</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">on_setattr</span> <span class="o">==</span> <span class="n">setters</span><span class="o">.</span><span class="n">validate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_validator</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">on_setattr</span> <span class="o">==</span> <span class="n">setters</span><span class="o">.</span><span class="n">convert</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_converter</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># If class-level on_setattr is set to convert + validate, but</span>
                <span class="c1"># there&#39;s no field to convert or validate, pretend like there&#39;s</span>
                <span class="c1"># no on_setattr.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_setattr</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">getstate_setstate</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__getstate__&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__setstate__&quot;</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_getstate_setstate</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;_ClassBuilder(cls=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">)&gt;&quot;</span>

    <span class="k">def</span> <span class="nf">build_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finalize class based on the accumulated configuration.</span>

<span class="sd">        Builder cannot be used after calling this method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_slots_class</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patch_original_class</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">PY_3_10_PLUS</span><span class="p">:</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">update_abstractmethods</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

        <span class="c1"># The method gets only called if it&#39;s not inherited from a base class.</span>
        <span class="c1"># _has_own_attribute does NOT work properly for classmethods.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_init_subclass__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="s2">&quot;__attrs_init_subclass__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">__attrs_init_subclass__</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="nf">_patch_original_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply accumulated methods and return the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span>
        <span class="n">base_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_names</span>

        <span class="c1"># Clean class of attribute definitions (`attr.ib()`s).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_attribs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_names</span>
                    <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">_SENTINEL</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_SENTINEL</span>
                <span class="p">):</span>
                    <span class="c1"># An AttributeError can happen if a base class defines a</span>
                    <span class="c1"># class variable and we want to set an attribute with the</span>
                    <span class="c1"># same name by using only a type annotation.</span>
                    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
                        <span class="nb">delattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Attach our dunder methods.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># If we&#39;ve inherited an attrs __setattr__ and don&#39;t write our own,</span>
        <span class="c1"># reset it to object&#39;s.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrote_own_setattr</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_own_setattr__&quot;</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">__attrs_own_setattr__</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_custom_setattr</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="fm">__setattr__</span> <span class="o">=</span> <span class="n">_OBJ_SETATTR</span>

        <span class="k">return</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="nf">_create_slots_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and return a new class with a `__slots__` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="o">*</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attr_names</span><span class="p">),</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="s2">&quot;__weakref__&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># If our class doesn&#39;t have its own implementation of __setattr__</span>
        <span class="c1"># (either from the user or by us), check the bases, if one of them has</span>
        <span class="c1"># an attrs-made __setattr__, that needs to be reset. We don&#39;t walk the</span>
        <span class="c1"># MRO because we only care about our immediate base classes.</span>
        <span class="c1"># XXX: This can be confused by subclassing a slotted attrs class with</span>
        <span class="c1"># XXX: a non-attrs class and subclass the resulting class with an attrs</span>
        <span class="c1"># XXX: class.  See `test_slotted_confused` for details.  For now that&#39;s</span>
        <span class="c1"># XXX: OK with us.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrote_own_setattr</span><span class="p">:</span>
            <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__attrs_own_setattr__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_custom_setattr</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">base_cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__attrs_own_setattr__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                        <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__setattr__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_OBJ_SETATTR</span>
                        <span class="k">break</span>

        <span class="c1"># Traverse the MRO to collect existing slots</span>
        <span class="c1"># and check for an existing __weakref__.</span>
        <span class="n">existing_slots</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">weakref_inherited</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">base_cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__weakref__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weakref_inherited</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">existing_slots</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base_cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base_cls</span><span class="p">,</span> <span class="s2">&quot;__slots__&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">base_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_names</span><span class="p">)</span>

        <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_names</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_weakref_slot</span>
            <span class="ow">and</span> <span class="s2">&quot;__weakref__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span> <span class="s2">&quot;__slots__&quot;</span><span class="p">,</span> <span class="p">())</span>
            <span class="ow">and</span> <span class="s2">&quot;__weakref__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">weakref_inherited</span>
        <span class="p">):</span>
            <span class="n">names</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;__weakref__&quot;</span><span class="p">,)</span>

        <span class="k">if</span> <span class="n">PY_3_8_PLUS</span><span class="p">:</span>
            <span class="n">cached_properties</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">cached_property</span><span class="o">.</span><span class="n">func</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cached_property</span> <span class="ow">in</span> <span class="n">cd</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cached_property</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">cached_property</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># `functools.cached_property` was introduced in 3.8.</span>
            <span class="c1"># So can&#39;t be used before this.</span>
            <span class="n">cached_properties</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Collect methods with a `__class__` reference that are shadowed in the new class.</span>
        <span class="c1"># To know to update them.</span>
        <span class="n">additional_closure_functions_to_update</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">cached_properties</span><span class="p">:</span>
            <span class="n">class_annotations</span> <span class="o">=</span> <span class="n">_get_annotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">cached_properties</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Add cached properties to names for slotting.</span>
                <span class="n">names</span> <span class="o">+=</span> <span class="p">(</span><span class="n">name</span><span class="p">,)</span>
                <span class="c1"># Clear out function from class to avoid clashing.</span>
                <span class="k">del</span> <span class="n">cd</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">additional_closure_functions_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">return_annotation</span>
                <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">class_annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span>

            <span class="n">original_getattr</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__getattr__&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">original_getattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">additional_closure_functions_to_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original_getattr</span><span class="p">)</span>

            <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__getattr__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_make_cached_property_getattr</span><span class="p">(</span>
                <span class="n">cached_properties</span><span class="p">,</span> <span class="n">original_getattr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span>
            <span class="p">)</span>

        <span class="c1"># We only add the names of attributes that aren&#39;t inherited.</span>
        <span class="c1"># Setting __slots__ to inherited attributes wastes memory.</span>
        <span class="n">slot_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_names</span><span class="p">]</span>

        <span class="c1"># There are slots for attributes from current class</span>
        <span class="c1"># that are defined in parent classes.</span>
        <span class="c1"># As their descriptors may be overridden by a child class,</span>
        <span class="c1"># we collect them here and update the class dict</span>
        <span class="n">reused_slots</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">slot</span><span class="p">:</span> <span class="n">slot_descriptor</span>
            <span class="k">for</span> <span class="n">slot</span><span class="p">,</span> <span class="n">slot_descriptor</span> <span class="ow">in</span> <span class="n">existing_slots</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">slot</span> <span class="ow">in</span> <span class="n">slot_names</span>
        <span class="p">}</span>
        <span class="n">slot_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">slot_names</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reused_slots</span><span class="p">]</span>
        <span class="n">cd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reused_slots</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_hash</span><span class="p">:</span>
            <span class="n">slot_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_HASH_CACHE_FIELD</span><span class="p">)</span>

        <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__slots__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">slot_names</span><span class="p">)</span>

        <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__qualname__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__qualname__</span>

        <span class="c1"># Create new class based on old class and our methods.</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">,</span> <span class="n">cd</span><span class="p">)</span>

        <span class="c1"># The following is a fix for</span>
        <span class="c1"># &lt;https://github.com/python-attrs/attrs/issues/102&gt;.</span>
        <span class="c1"># If a method mentions `__class__` or uses the no-arg super(), the</span>
        <span class="c1"># compiler will bake a reference to the class in the method itself</span>
        <span class="c1"># as `method.__closure__`.  Since we replace the class with a</span>
        <span class="c1"># clone, we rewrite these references so it keeps working.</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">additional_closure_functions_to_update</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">classmethod</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">)):</span>
                <span class="c1"># Class- and staticmethods hide their functions inside.</span>
                <span class="c1"># These might need to be rewritten as well.</span>
                <span class="n">closure_cells</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="vm">__func__</span><span class="p">,</span> <span class="s2">&quot;__closure__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
                <span class="c1"># Workaround for property `super()` shortcut (PY3-only).</span>
                <span class="c1"># There is no universal way for other descriptors.</span>
                <span class="n">closure_cells</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="s2">&quot;__closure__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">closure_cells</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;__closure__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">closure_cells</span><span class="p">:</span>  <span class="c1"># Catch None or the empty list.</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">closure_cells</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">cell_contents</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># noqa: PERF203</span>
                    <span class="c1"># ValueError: Cell is empty</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">cell</span><span class="o">.</span><span class="n">cell_contents</span> <span class="o">=</span> <span class="bp">cls</span>
        <span class="k">return</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="nf">add_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__repr__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span>
            <span class="n">_make_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">repr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__repr__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">repr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;__str__ can only be generated if a __repr__ exists.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__str__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span><span class="fm">__str__</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_make_getstate_setstate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create custom __setstate__ and __getstate__ methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># __weakref__ is not writable.</span>
        <span class="n">state_attr_names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">an</span> <span class="k">for</span> <span class="n">an</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attr_names</span> <span class="k">if</span> <span class="n">an</span> <span class="o">!=</span> <span class="s2">&quot;__weakref__&quot;</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">slots_getstate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Automatically created by attrs.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">state_attr_names</span><span class="p">}</span>

        <span class="n">hash_caching_enabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_hash</span>

        <span class="k">def</span> <span class="nf">slots_setstate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Automatically created by attrs.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">__bound_setattr</span> <span class="o">=</span> <span class="n">_OBJ_SETATTR</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="c1"># Backward compatibility with attrs instances pickled with</span>
                <span class="c1"># attrs versions before v22.2.0 which stored tuples.</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">state_attr_names</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
                    <span class="n">__bound_setattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">state_attr_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
                        <span class="n">__bound_setattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

            <span class="c1"># The hash code cache is not included when the object is</span>
            <span class="c1"># serialized, but it still needs to be initialized to None to</span>
            <span class="c1"># indicate that the first call to __hash__ should be a cache</span>
            <span class="c1"># miss.</span>
            <span class="k">if</span> <span class="n">hash_caching_enabled</span><span class="p">:</span>
                <span class="n">__bound_setattr</span><span class="p">(</span><span class="n">_HASH_CACHE_FIELD</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">slots_getstate</span><span class="p">,</span> <span class="n">slots_setstate</span>

    <span class="k">def</span> <span class="nf">make_unhashable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__hash__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__hash__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span>
            <span class="n">_make_hash</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">,</span>
                <span class="n">frozen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span><span class="p">,</span>
                <span class="n">cache_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache_hash</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span>
            <span class="n">_make_init</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_has_pre_init</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pre_init_has_args</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_has_post_init</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache_hash</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_attr_map</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_exc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_setattr</span><span class="p">,</span>
                <span class="n">attrs_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_match_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__match_args__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">name</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">init</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">kw_only</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_attrs_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__attrs_init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span>
            <span class="n">_make_init</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_has_pre_init</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pre_init_has_args</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_has_post_init</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_slots</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cache_hash</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_attr_map</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_exc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_on_setattr</span><span class="p">,</span>
                <span class="n">attrs_init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span>

        <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__eq__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span>
            <span class="n">_make_eq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__ne__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span><span class="n">_make_ne</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span>

        <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__lt__&quot;</span><span class="p">],</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__le__&quot;</span><span class="p">],</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__gt__&quot;</span><span class="p">],</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;__ge__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="n">_make_order</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">add_setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="n">sa_attrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attrs</span><span class="p">:</span>
            <span class="n">on_setattr</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">on_setattr</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_on_setattr</span>
            <span class="k">if</span> <span class="n">on_setattr</span> <span class="ow">and</span> <span class="n">on_setattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">setters</span><span class="o">.</span><span class="n">NO_OP</span><span class="p">:</span>
                <span class="n">sa_attrs</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">on_setattr</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sa_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_custom_setattr</span><span class="p">:</span>
            <span class="c1"># We need to write a __setattr__ but there already is one!</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t combine custom __setattr__ with on_setattr hooks.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># docstring comes from _add_method_dunders</span>
        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">hook</span> <span class="o">=</span> <span class="n">sa_attrs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">nval</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nval</span> <span class="o">=</span> <span class="n">hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

            <span class="n">_OBJ_SETATTR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">nval</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__attrs_own_setattr__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cls_dict</span><span class="p">[</span><span class="s2">&quot;__setattr__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_method_dunders</span><span class="p">(</span><span class="fm">__setattr__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrote_own_setattr</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_add_method_dunders</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add __module__ and __qualname__ to a *method* if possible.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">method</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__module__</span>

        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">method</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">method</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Method generated by attrs for class &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">method</span>


<span class="k">def</span> <span class="nf">_determine_attrs_eq_order</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">default_eq</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the combination of *cmp*, *eq*, and *order*. Derive the effective</span>
<span class="sd">    values of eq and order.  If *eq* is None, set it to *default_eq*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span><span class="n">eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Don&#39;t mix `cmp` with `eq&#39; and `order`.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># cmp takes precedence due to bw-compatibility.</span>
    <span class="k">if</span> <span class="n">cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cmp</span><span class="p">,</span> <span class="n">cmp</span>

    <span class="c1"># If left None, equality is set to the specified default and ordering</span>
    <span class="c1"># mirrors equality.</span>
    <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">default_eq</span>

    <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">eq</span>

    <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;`order` can only be True if `eq` is True too.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eq</span><span class="p">,</span> <span class="n">order</span>


<span class="k">def</span> <span class="nf">_determine_attrib_eq_order</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">default_eq</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the combination of *cmp*, *eq*, and *order*. Derive the effective</span>
<span class="sd">    values of eq and order.  If *eq* is None, set it to *default_eq*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">((</span><span class="n">eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Don&#39;t mix `cmp` with `eq&#39; and `order`.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decide_callable_or_boolean</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decide whether a key function is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span>

    <span class="c1"># cmp takes precedence due to bw-compatibility.</span>
    <span class="k">if</span> <span class="n">cmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmp</span><span class="p">,</span> <span class="n">cmp_key</span> <span class="o">=</span> <span class="n">decide_callable_or_boolean</span><span class="p">(</span><span class="n">cmp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmp</span><span class="p">,</span> <span class="n">cmp_key</span><span class="p">,</span> <span class="n">cmp</span><span class="p">,</span> <span class="n">cmp_key</span>

    <span class="c1"># If left None, equality is set to the specified default and ordering</span>
    <span class="c1"># mirrors equality.</span>
    <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eq</span><span class="p">,</span> <span class="n">eq_key</span> <span class="o">=</span> <span class="n">default_eq</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eq</span><span class="p">,</span> <span class="n">eq_key</span> <span class="o">=</span> <span class="n">decide_callable_or_boolean</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">order</span><span class="p">,</span> <span class="n">order_key</span> <span class="o">=</span> <span class="n">eq</span><span class="p">,</span> <span class="n">eq_key</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">order</span><span class="p">,</span> <span class="n">order_key</span> <span class="o">=</span> <span class="n">decide_callable_or_boolean</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;`order` can only be True if `eq` is True too.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">eq</span><span class="p">,</span> <span class="n">eq_key</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">order_key</span>


<span class="k">def</span> <span class="nf">_determine_whether_to_implement</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">auto_detect</span><span class="p">,</span> <span class="n">dunders</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether we should implement a set of methods for *cls*.</span>

<span class="sd">    *flag* is the argument passed into @attr.s like &#39;init&#39;, *auto_detect* the</span>
<span class="sd">    same as passed into @attr.s and *dunders* is a tuple of attribute names</span>
<span class="sd">    whose presence signal that the user has implemented it themselves.</span>

<span class="sd">    Return *default* if no reason for either for or against is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flag</span>

    <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">auto_detect</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="c1"># Logically, flag is None and auto_detect is True here.</span>
    <span class="k">for</span> <span class="n">dunder</span> <span class="ow">in</span> <span class="n">dunders</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_has_own_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dunder</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">default</span>


<div class="viewcode-block" id="attrs">
<a class="viewcode-back" href="../../docs/reference/_autosummary/datumaro.components.merge.intersect_merge.html#datumaro.components.annotations.matcher.attrs">[docs]</a>
<span class="k">def</span> <span class="nf">attrs</span><span class="p">(</span>
    <span class="n">maybe_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">these</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">repr_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="nb">repr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">slots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">weakref_slot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="nb">str</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">kw_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cache_hash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">auto_exc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">eq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">auto_detect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">collect_by_mro</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">getstate_setstate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">on_setattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">field_transformer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">match_args</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">unsafe_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class decorator that adds :term:`dunder methods` according to the</span>
<span class="sd">    specified attributes using `attr.ib` or the *these* argument.</span>

<span class="sd">    Consider using `attrs.define` / `attrs.frozen` in new code (``attr.s`` will</span>
<span class="sd">    *never* go away, though).</span>

<span class="sd">    Args:</span>
<span class="sd">        repr_ns (str):</span>
<span class="sd">            When using nested classes, there was no way in Python 2 to</span>
<span class="sd">            automatically detect that.  This argument allows to set a custom</span>
<span class="sd">            name for a more meaningful ``repr`` output.  This argument is</span>
<span class="sd">            pointless in Python 3 and is therefore deprecated.</span>

<span class="sd">    .. caution::</span>
<span class="sd">        Refer to `attrs.define` for the rest of the parameters, but note that they</span>
<span class="sd">        can have different defaults.</span>

<span class="sd">        Notably, leaving *on_setattr* as `None` will **not** add any hooks.</span>

<span class="sd">    .. versionadded:: 16.0.0 *slots*</span>
<span class="sd">    .. versionadded:: 16.1.0 *frozen*</span>
<span class="sd">    .. versionadded:: 16.3.0 *str*</span>
<span class="sd">    .. versionadded:: 16.3.0 Support for ``__attrs_post_init__``.</span>
<span class="sd">    .. versionchanged:: 17.1.0</span>
<span class="sd">       *hash* supports `None` as value which is also the default now.</span>
<span class="sd">    .. versionadded:: 17.3.0 *auto_attribs*</span>
<span class="sd">    .. versionchanged:: 18.1.0</span>
<span class="sd">       If *these* is passed, no attributes are deleted from the class body.</span>
<span class="sd">    .. versionchanged:: 18.1.0 If *these* is ordered, the order is retained.</span>
<span class="sd">    .. versionadded:: 18.2.0 *weakref_slot*</span>
<span class="sd">    .. deprecated:: 18.2.0</span>
<span class="sd">       ``__lt__``, ``__le__``, ``__gt__``, and ``__ge__`` now raise a</span>
<span class="sd">       `DeprecationWarning` if the classes compared are subclasses of</span>
<span class="sd">       each other. ``__eq`` and ``__ne__`` never tried to compared subclasses</span>
<span class="sd">       to each other.</span>
<span class="sd">    .. versionchanged:: 19.2.0</span>
<span class="sd">       ``__lt__``, ``__le__``, ``__gt__``, and ``__ge__`` now do not consider</span>
<span class="sd">       subclasses comparable anymore.</span>
<span class="sd">    .. versionadded:: 18.2.0 *kw_only*</span>
<span class="sd">    .. versionadded:: 18.2.0 *cache_hash*</span>
<span class="sd">    .. versionadded:: 19.1.0 *auto_exc*</span>
<span class="sd">    .. deprecated:: 19.2.0 *cmp* Removal on or after 2021-06-01.</span>
<span class="sd">    .. versionadded:: 19.2.0 *eq* and *order*</span>
<span class="sd">    .. versionadded:: 20.1.0 *auto_detect*</span>
<span class="sd">    .. versionadded:: 20.1.0 *collect_by_mro*</span>
<span class="sd">    .. versionadded:: 20.1.0 *getstate_setstate*</span>
<span class="sd">    .. versionadded:: 20.1.0 *on_setattr*</span>
<span class="sd">    .. versionadded:: 20.3.0 *field_transformer*</span>
<span class="sd">    .. versionchanged:: 21.1.0</span>
<span class="sd">       ``init=False`` injects ``__attrs_init__``</span>
<span class="sd">    .. versionchanged:: 21.1.0 Support for ``__attrs_pre_init__``</span>
<span class="sd">    .. versionchanged:: 21.1.0 *cmp* undeprecated</span>
<span class="sd">    .. versionadded:: 21.3.0 *match_args*</span>
<span class="sd">    .. versionadded:: 22.2.0</span>
<span class="sd">       *unsafe_hash* as an alias for *hash* (for :pep:`681` compliance).</span>
<span class="sd">    .. deprecated:: 24.1.0 *repr_ns*</span>
<span class="sd">    .. versionchanged:: 24.1.0</span>
<span class="sd">       Instances are not compared as tuples of attributes anymore, but using a</span>
<span class="sd">       big ``and`` condition. This is faster and has more correct behavior for</span>
<span class="sd">       uncomparable values like `math.nan`.</span>
<span class="sd">    .. versionadded:: 24.1.0</span>
<span class="sd">       If a class has an *inherited* classmethod called</span>
<span class="sd">       ``__attrs_init_subclass__``, it is executed after the class is created.</span>
<span class="sd">    .. deprecated:: 24.1.0 *hash* is deprecated in favor of *unsafe_hash*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">repr_ns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">warnings</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="ne">DeprecationWarning</span><span class="p">(</span>
                <span class="s2">&quot;The `repr_ns` argument is deprecated and will be removed in or after August 2025.&quot;</span>
            <span class="p">),</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">eq_</span><span class="p">,</span> <span class="n">order_</span> <span class="o">=</span> <span class="n">_determine_attrs_eq_order</span><span class="p">(</span><span class="n">cmp</span><span class="p">,</span> <span class="n">eq</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1">#  unsafe_hash takes precedence due to PEP 681.</span>
    <span class="k">if</span> <span class="n">unsafe_hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">hash</span> <span class="o">=</span> <span class="n">unsafe_hash</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on_setattr</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">on_setattr</span> <span class="o">=</span> <span class="n">setters</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="o">*</span><span class="n">on_setattr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">is_frozen</span> <span class="o">=</span> <span class="n">frozen</span> <span class="ow">or</span> <span class="n">_has_frozen_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">is_exc</span> <span class="o">=</span> <span class="n">auto_exc</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">)</span>
        <span class="n">has_own_setattr</span> <span class="o">=</span> <span class="n">auto_detect</span> <span class="ow">and</span> <span class="n">_has_own_attribute</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__setattr__&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">has_own_setattr</span> <span class="ow">and</span> <span class="n">is_frozen</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can&#39;t freeze a class with a custom __setattr__.&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">builder</span> <span class="o">=</span> <span class="n">_ClassBuilder</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">these</span><span class="p">,</span>
            <span class="n">slots</span><span class="p">,</span>
            <span class="n">is_frozen</span><span class="p">,</span>
            <span class="n">weakref_slot</span><span class="p">,</span>
            <span class="n">_determine_whether_to_implement</span><span class="p">(</span>
                <span class="bp">cls</span><span class="p">,</span>
                <span class="n">getstate_setstate</span><span class="p">,</span>
                <span class="n">auto_detect</span><span class="p">,</span>
                <span class="p">(</span><span class="s2">&quot;__getstate__&quot;</span><span class="p">,</span> <span class="s2">&quot;__setstate__&quot;</span><span class="p">),</span>
                <span class="n">default</span><span class="o">=</span><span class="n">slots</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">auto_attribs</span><span class="p">,</span>
            <span class="n">kw_only</span><span class="p">,</span>
            <span class="n">cache_hash</span><span class="p">,</span>
            <span class="n">is_exc</span><span class="p">,</span>
            <span class="n">collect_by_mro</span><span class="p">,</span>
            <span class="n">on_setattr</span><span class="p">,</span>
            <span class="n">has_own_setattr</span><span class="p">,</span>
            <span class="n">field_transformer</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">_determine_whether_to_implement</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="nb">repr</span><span class="p">,</span> <span class="n">auto_detect</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;__repr__&quot;</span><span class="p">,)</span>
        <span class="p">):</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_repr</span><span class="p">(</span><span class="n">repr_ns</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_str</span><span class="p">()</span>

        <span class="n">eq</span> <span class="o">=</span> <span class="n">_determine_whether_to_implement</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">eq_</span><span class="p">,</span> <span class="n">auto_detect</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;__eq__&quot;</span><span class="p">,</span> <span class="s2">&quot;__ne__&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_exc</span> <span class="ow">and</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_eq</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_exc</span> <span class="ow">and</span> <span class="n">_determine_whether_to_implement</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">order_</span><span class="p">,</span> <span class="n">auto_detect</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;__lt__&quot;</span><span class="p">,</span> <span class="s2">&quot;__le__&quot;</span><span class="p">,</span> <span class="s2">&quot;__gt__&quot;</span><span class="p">,</span> <span class="s2">&quot;__ge__&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_order</span><span class="p">()</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_setattr</span><span class="p">()</span>

        <span class="k">nonlocal</span> <span class="nb">hash</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">auto_detect</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="ow">and</span> <span class="n">_has_own_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__hash__&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="nb">hash</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Can&#39;t use `hash in` because 1 == True for example.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid value for hash.  Must be True, False, or None.&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hash</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_exc</span><span class="p">:</span>
            <span class="c1"># Don&#39;t do anything. Should fall back to __object__&#39;s __hash__</span>
            <span class="c1"># which is by id.</span>
            <span class="k">if</span> <span class="n">cache_hash</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid value for cache_hash.  To use hash caching, hashing must be either explicitly or implicitly enabled.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">is_frozen</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="p">):</span>
            <span class="c1"># Build a __hash__ if told so, or if it&#39;s safe.</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_hash</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Raise TypeError on attempts to hash.</span>
            <span class="k">if</span> <span class="n">cache_hash</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid value for cache_hash.  To use hash caching, hashing must be either explicitly or implicitly enabled.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">make_unhashable</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">_determine_whether_to_implement</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">auto_detect</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;__init__&quot;</span><span class="p">,)</span>
        <span class="p">):</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_init</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_attrs_init</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cache_hash</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid value for cache_hash.  To use hash caching, init must be True.&quot;</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">PY_3_10_PLUS</span>
            <span class="ow">and</span> <span class="n">match_args</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">_has_own_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__match_args__&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">add_match_args</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">build_class</span><span class="p">()</span>

    <span class="c1"># maybe_cls&#39;s type depends on the usage of the decorator.  It&#39;s a class</span>
    <span class="c1"># if it&#39;s used as `@attrs` but `None` if used as `@attrs()`.</span>
    <span class="k">if</span> <span class="n">maybe_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wrap</span>

    <span class="k">return</span> <span class="n">wrap</span><span class="p">(</span><span class="n">maybe_cls</span><span class="p">)</span></div>



<span class="n">_attrs</span> <span class="o">=</span> <span class="n">attrs</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Internal alias so we can use it in functions that take an argument called</span>
<span class="sd">*attrs*.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_has_frozen_base_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether *cls* has a frozen ancestor by looking at its</span>
<span class="sd">    __setattr__.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__setattr__</span> <span class="ow">is</span> <span class="n">_frozen_setattrs</span>


<span class="k">def</span> <span class="nf">_generate_unique_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">func_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a &quot;filename&quot; suitable for a function being generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&lt;attrs generated </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;__qualname__&#39;</span><span class="p">,</span><span class="w"> </span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_hash</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">frozen</span><span class="p">,</span> <span class="n">cache_hash</span><span class="p">):</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">hash</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">hash</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">eq</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">tab</span> <span class="o">=</span> <span class="s2">&quot;        &quot;</span>

    <span class="n">unique_filename</span> <span class="o">=</span> <span class="n">_generate_unique_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;hash&quot;</span><span class="p">)</span>
    <span class="n">type_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">unique_filename</span><span class="p">)</span>
    <span class="c1"># If eq is custom generated, we need to include the functions in globs</span>
    <span class="n">globs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">hash_def</span> <span class="o">=</span> <span class="s2">&quot;def __hash__(self&quot;</span>
    <span class="n">hash_func</span> <span class="o">=</span> <span class="s2">&quot;hash((&quot;</span>
    <span class="n">closing_braces</span> <span class="o">=</span> <span class="s2">&quot;))&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_hash</span><span class="p">:</span>
        <span class="n">hash_def</span> <span class="o">+=</span> <span class="s2">&quot;):&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hash_def</span> <span class="o">+=</span> <span class="s2">&quot;, *&quot;</span>

        <span class="n">hash_def</span> <span class="o">+=</span> <span class="s2">&quot;, _cache_wrapper=__import__(&#39;attr._make&#39;)._make._CacheHashWrapper):&quot;</span>
        <span class="n">hash_func</span> <span class="o">=</span> <span class="s2">&quot;_cache_wrapper(&quot;</span> <span class="o">+</span> <span class="n">hash_func</span>
        <span class="n">closing_braces</span> <span class="o">+=</span> <span class="s2">&quot;)&quot;</span>

    <span class="n">method_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">hash_def</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">append_hash_computation_lines</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the code for actually computing the hash code.</span>
<span class="sd">        Below this will either be returned directly or used to compute</span>
<span class="sd">        a value which is then cached, depending on the value of cache_hash</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">method_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">indent</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">hash_func</span><span class="p">,</span>
                <span class="n">indent</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">type_hash</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">eq_key</span><span class="p">:</span>
                <span class="n">cmp_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_key&quot;</span>
                <span class="n">globs</span><span class="p">[</span><span class="n">cmp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">eq_key</span>
                <span class="n">method_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">indent</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">cmp_name</span><span class="si">}</span><span class="s2">(self.</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">),&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">method_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;        self.</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">,&quot;</span><span class="p">)</span>

        <span class="n">method_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">closing_braces</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cache_hash</span><span class="p">:</span>
        <span class="n">method_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;if self.</span><span class="si">{</span><span class="n">_HASH_CACHE_FIELD</span><span class="si">}</span><span class="s2"> is None:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frozen</span><span class="p">:</span>
            <span class="n">append_hash_computation_lines</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;object.__setattr__(self, &#39;</span><span class="si">{</span><span class="n">_HASH_CACHE_FIELD</span><span class="si">}</span><span class="s2">&#39;, &quot;</span><span class="p">,</span> <span class="n">tab</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">method_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>  <span class="c1"># close __setattr__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">append_hash_computation_lines</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">_HASH_CACHE_FIELD</span><span class="si">}</span><span class="s2"> = &quot;</span><span class="p">,</span> <span class="n">tab</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">)</span>
        <span class="n">method_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tab</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;return self.</span><span class="si">{</span><span class="n">_HASH_CACHE_FIELD</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">append_hash_computation_lines</span><span class="p">(</span><span class="s2">&quot;return &quot;</span><span class="p">,</span> <span class="n">tab</span><span class="p">)</span>

    <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">method_lines</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_make_method</span><span class="p">(</span><span class="s2">&quot;__hash__&quot;</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">unique_filename</span><span class="p">,</span> <span class="n">globs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_hash</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a hash method to *cls*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span><span class="o">.</span><span class="fm">__hash__</span> <span class="o">=</span> <span class="n">_make_hash</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache_hash</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span>


<span class="k">def</span> <span class="nf">_make_ne</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create __ne__ method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check equality and either forward a NotImplemented or</span>
<span class="sd">        return the result negated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="n">result</span>

    <span class="k">return</span> <span class="fm">__ne__</span>


<span class="k">def</span> <span class="nf">_make_eq</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create __eq__ method for *cls* with *attrs*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">eq</span><span class="p">]</span>

    <span class="n">unique_filename</span> <span class="o">=</span> <span class="n">_generate_unique_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;eq&quot;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;def __eq__(self, other):&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    if other.__class__ is not self.__class__:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;        return NotImplemented&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># We can&#39;t just do a big self.x = other.x and... clause due to</span>
    <span class="c1"># irregularities like nan == nan is false but (nan,) == (nan,) is true.</span>
    <span class="n">globs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    return  (&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">eq_key</span><span class="p">:</span>
                <span class="n">cmp_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_key&quot;</span>
                <span class="c1"># Add the key function to the global namespace</span>
                <span class="c1"># of the evaluated function.</span>
                <span class="n">globs</span><span class="p">[</span><span class="n">cmp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">eq_key</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">cmp_name</span><span class="si">}</span><span class="s2">(self.</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">) == </span><span class="si">{</span><span class="n">cmp_name</span><span class="si">}</span><span class="s2">(other.</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        self.</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> == other.</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">attrs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> and&quot;</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    )&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    return True&quot;</span><span class="p">)</span>

    <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_make_method</span><span class="p">(</span><span class="s2">&quot;__eq__&quot;</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">unique_filename</span><span class="p">,</span> <span class="n">globs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_make_order</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create ordering methods for *cls* with *attrs*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">order</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">attrs_to_tuple</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save us some typing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">key</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="n">value</span>
            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">a</span><span class="o">.</span><span class="n">order_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically created by attrs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attrs_to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">attrs_to_tuple</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically created by attrs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attrs_to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">attrs_to_tuple</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically created by attrs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attrs_to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">attrs_to_tuple</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="fm">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Automatically created by attrs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">attrs_to_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">attrs_to_tuple</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">return</span> <span class="fm">__lt__</span><span class="p">,</span> <span class="fm">__le__</span><span class="p">,</span> <span class="fm">__gt__</span><span class="p">,</span> <span class="fm">__ge__</span>


<span class="k">def</span> <span class="nf">_add_eq</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add equality methods to *cls* with *attrs*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__attrs_attrs__</span>

    <span class="bp">cls</span><span class="o">.</span><span class="fm">__eq__</span> <span class="o">=</span> <span class="n">_make_eq</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
    <span class="bp">cls</span><span class="o">.</span><span class="fm">__ne__</span> <span class="o">=</span> <span class="n">_make_ne</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">cls</span>


<span class="k">def</span> <span class="nf">_make_repr</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="n">unique_filename</span> <span class="o">=</span> <span class="n">_generate_unique_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;repr&quot;</span><span class="p">)</span>
    <span class="c1"># Figure out which attributes to include, and which function to use to</span>
    <span class="c1"># format them. The a.repr value can be either bool or a custom</span>
    <span class="c1"># callable.</span>
    <span class="n">attr_names_with_reprs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="nb">repr</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">repr</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">a</span><span class="o">.</span><span class="n">repr</span><span class="p">),</span> <span class="n">a</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">repr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">globs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_repr&quot;</span><span class="p">:</span> <span class="n">r</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">attr_names_with_reprs</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="nb">repr</span>
    <span class="p">}</span>
    <span class="n">globs</span><span class="p">[</span><span class="s2">&quot;_compat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_compat</span>
    <span class="n">globs</span><span class="p">[</span><span class="s2">&quot;AttributeError&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="ne">AttributeError</span>
    <span class="n">globs</span><span class="p">[</span><span class="s2">&quot;NOTHING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOTHING</span>
    <span class="n">attribute_fragments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attr_names_with_reprs</span><span class="p">:</span>
        <span class="n">accessor</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;self.&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="s1">&#39;getattr(self, &quot;&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;&quot;, NOTHING)&#39;</span>
        <span class="p">)</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">={</span><span class="si">%s</span><span class="s2">!r}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">accessor</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="nb">repr</span>
            <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">={</span><span class="si">%s</span><span class="s2">_repr(</span><span class="si">%s</span><span class="s2">)}&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">accessor</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">attribute_fragments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
    <span class="n">repr_fragment</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attribute_fragments</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cls_name_fragment</span> <span class="o">=</span> <span class="s1">&#39;{self.__class__.__qualname__.rsplit(&quot;&gt;.&quot;, 1)[-1]}&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cls_name_fragment</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">+</span> <span class="s2">&quot;.</span><span class="si">{self.__class__.__name__}</span><span class="s2">&quot;</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;def __repr__(self):&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  try:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    already_repring = _compat.repr_context.already_repring&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  except AttributeError:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    already_repring = {id(self),}&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    _compat.repr_context.already_repring = already_repring&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  else:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    if id(self) in already_repring:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;      return &#39;...&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    else:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;      already_repring.add(id(self))&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  try:&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;    return f&#39;</span><span class="si">{</span><span class="n">cls_name_fragment</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">repr_fragment</span><span class="si">}</span><span class="s2">)&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  finally:&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    already_repring.remove(id(self))&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">_make_method</span><span class="p">(</span>
        <span class="s2">&quot;__repr__&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="n">unique_filename</span><span class="p">,</span> <span class="n">globs</span><span class="o">=</span><span class="n">globs</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_add_repr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a repr method to *cls*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__attrs_attrs__</span>

    <span class="bp">cls</span><span class="o">.</span><span class="fm">__repr__</span> <span class="o">=</span> <span class="n">_make_repr</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span>


<span class="k">def</span> <span class="nf">fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the tuple of *attrs* attributes for a class.</span>

<span class="sd">    The tuple also allows accessing the fields by their names (see below for</span>
<span class="sd">    examples).</span>

<span class="sd">    Args:</span>
<span class="sd">        cls (type): Class to introspect.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If *cls* is not a class.</span>

<span class="sd">        attrs.exceptions.NotAnAttrsClassError:</span>
<span class="sd">            If *cls* is not an *attrs* class.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple (with name accessors) of `attrs.Attribute`</span>

<span class="sd">    .. versionchanged:: 16.2.0 Returned tuple allows accessing the fields</span>
<span class="sd">       by name.</span>
<span class="sd">    .. versionchanged:: 23.1.0 Add support for generic classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">generic_base</span> <span class="o">=</span> <span class="n">get_generic_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">generic_base</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Passed object must be a class.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">generic_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">generic_base</span><span class="p">,</span> <span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Even though this is global state, stick it on here to speed</span>
                <span class="c1"># it up. We rely on `cls` being cached for this to be</span>
                <span class="c1"># efficient.</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">__attrs_attrs__</span> <span class="o">=</span> <span class="n">attrs</span>
                <span class="k">return</span> <span class="n">attrs</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> is not an attrs-decorated class.&quot;</span>
        <span class="k">raise</span> <span class="n">NotAnAttrsClassError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">attrs</span>


<span class="k">def</span> <span class="nf">fields_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return an ordered dictionary of *attrs* attributes for a class, whose keys</span>
<span class="sd">    are the attribute names.</span>

<span class="sd">    Args:</span>
<span class="sd">        cls (type): Class to introspect.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TypeError: If *cls* is not a class.</span>

<span class="sd">        attrs.exceptions.NotAnAttrsClassError:</span>
<span class="sd">            If *cls* is not an *attrs* class.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, attrs.Attribute]: Dict of attribute name to definition</span>

<span class="sd">    .. versionadded:: 18.1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Passed object must be a class.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__attrs_attrs__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> is not an attrs-decorated class.&quot;</span>
        <span class="k">raise</span> <span class="n">NotAnAttrsClassError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">inst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate all attributes on *inst* that have a validator.</span>

<span class="sd">    Leaves all exceptions through.</span>

<span class="sd">    Args:</span>
<span class="sd">        inst: Instance of a class with *attrs* attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_config</span><span class="o">.</span><span class="n">_run_validators</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">(</span><span class="n">inst</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">validator</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_is_slot_attr</span><span class="p">(</span><span class="n">a_name</span><span class="p">,</span> <span class="n">base_attr_map</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the attribute name comes from a slot class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">base_attr_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span> <span class="ow">and</span> <span class="s2">&quot;__slots__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>


<span class="k">def</span> <span class="nf">_make_init</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">attrs</span><span class="p">,</span>
    <span class="n">pre_init</span><span class="p">,</span>
    <span class="n">pre_init_has_args</span><span class="p">,</span>
    <span class="n">post_init</span><span class="p">,</span>
    <span class="n">frozen</span><span class="p">,</span>
    <span class="n">slots</span><span class="p">,</span>
    <span class="n">cache_hash</span><span class="p">,</span>
    <span class="n">base_attr_map</span><span class="p">,</span>
    <span class="n">is_exc</span><span class="p">,</span>
    <span class="n">cls_on_setattr</span><span class="p">,</span>
    <span class="n">attrs_init</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">has_cls_on_setattr</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">cls_on_setattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cls_on_setattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">setters</span><span class="o">.</span><span class="n">NO_OP</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">frozen</span> <span class="ow">and</span> <span class="n">has_cls_on_setattr</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Frozen classes can&#39;t use on_setattr.&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">needs_cached_setattr</span> <span class="o">=</span> <span class="n">cache_hash</span> <span class="ow">or</span> <span class="n">frozen</span>
    <span class="n">filtered_attrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attr_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">init</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">NOTHING</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">filtered_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">attr_dict</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>

        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">on_setattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frozen</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Frozen classes can&#39;t use on_setattr.&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">needs_cached_setattr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">has_cls_on_setattr</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">on_setattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">setters</span><span class="o">.</span><span class="n">NO_OP</span><span class="p">:</span>
            <span class="n">needs_cached_setattr</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">unique_filename</span> <span class="o">=</span> <span class="n">_generate_unique_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;init&quot;</span><span class="p">)</span>

    <span class="n">script</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">annotations</span> <span class="o">=</span> <span class="n">_attrs_to_init_script</span><span class="p">(</span>
        <span class="n">filtered_attrs</span><span class="p">,</span>
        <span class="n">frozen</span><span class="p">,</span>
        <span class="n">slots</span><span class="p">,</span>
        <span class="n">pre_init</span><span class="p">,</span>
        <span class="n">pre_init_has_args</span><span class="p">,</span>
        <span class="n">post_init</span><span class="p">,</span>
        <span class="n">cache_hash</span><span class="p">,</span>
        <span class="n">base_attr_map</span><span class="p">,</span>
        <span class="n">is_exc</span><span class="p">,</span>
        <span class="n">needs_cached_setattr</span><span class="p">,</span>
        <span class="n">has_cls_on_setattr</span><span class="p">,</span>
        <span class="s2">&quot;__attrs_init__&quot;</span> <span class="k">if</span> <span class="n">attrs_init</span> <span class="k">else</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="c1"># This makes typing.get_type_hints(CLS.__init__) resolve string types.</span>
        <span class="n">globs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

    <span class="n">globs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;NOTHING&quot;</span><span class="p">:</span> <span class="n">NOTHING</span><span class="p">,</span> <span class="s2">&quot;attr_dict&quot;</span><span class="p">:</span> <span class="n">attr_dict</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">needs_cached_setattr</span><span class="p">:</span>
        <span class="c1"># Save the lookup overhead in __init__ if we need to circumvent</span>
        <span class="c1"># setattr hooks.</span>
        <span class="n">globs</span><span class="p">[</span><span class="s2">&quot;_cached_setattr_get&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_OBJ_SETATTR</span><span class="o">.</span><span class="fm">__get__</span>

    <span class="n">init</span> <span class="o">=</span> <span class="n">_make_method</span><span class="p">(</span>
        <span class="s2">&quot;__attrs_init__&quot;</span> <span class="k">if</span> <span class="n">attrs_init</span> <span class="k">else</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span>
        <span class="n">script</span><span class="p">,</span>
        <span class="n">unique_filename</span><span class="p">,</span>
        <span class="n">globs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">init</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="n">annotations</span>

    <span class="k">return</span> <span class="n">init</span>


<span class="k">def</span> <span class="nf">_setattr</span><span class="p">(</span><span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the cached object.setattr to set *attr_name* to *value_var*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;_setattr(&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="k">def</span> <span class="nf">_setattr_with_converter</span><span class="p">(</span>
    <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">converter</span><span class="p">:</span> <span class="n">Converter</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the cached object.setattr to set *attr_name* to *value_var*, but run</span>
<span class="sd">    its converter first.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;_setattr(&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;, </span><span class="si">{</span><span class="n">converter</span><span class="o">.</span><span class="n">_fmt_converter_call</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span><span class="w"> </span><span class="n">value_var</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>


<span class="k">def</span> <span class="nf">_assign</span><span class="p">(</span><span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unless *attr_name* has an on_setattr hook, use normal assignment. Otherwise</span>
<span class="sd">    relegate to _setattr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">has_on_setattr</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_setattr</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_assign_with_converter</span><span class="p">(</span>
    <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">converter</span><span class="p">:</span> <span class="n">Converter</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unless *attr_name* has an on_setattr hook, use normal assignment after</span>
<span class="sd">    conversion. Otherwise relegate to _setattr_with_converter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">has_on_setattr</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_setattr_with_converter</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">value_var</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">converter</span><span class="o">.</span><span class="n">_fmt_converter_call</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span><span class="w"> </span><span class="n">value_var</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span> <span class="nf">_determine_setters</span><span class="p">(</span>
    <span class="n">frozen</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">slots</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">base_attr_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the correct setter functions based on whether a class is frozen</span>
<span class="sd">    and/or slotted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">frozen</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">slots</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(),</span> <span class="n">_setattr</span><span class="p">,</span> <span class="n">_setattr_with_converter</span>

        <span class="c1"># Dict frozen classes assign directly to __dict__.</span>
        <span class="c1"># But only if the attribute doesn&#39;t come from an ancestor slot</span>
        <span class="c1"># class.</span>
        <span class="c1"># Note _inst_dict will be used again below if cache_hash is True</span>

        <span class="k">def</span> <span class="nf">fmt_setter</span><span class="p">(</span>
            <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_is_slot_attr</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">base_attr_map</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_setattr</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">value_var</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">)</span>

            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;_inst_dict[&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;] = </span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span> <span class="nf">fmt_setter_with_converter</span><span class="p">(</span>
            <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">has_on_setattr</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="n">converter</span><span class="p">:</span> <span class="n">Converter</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_on_setattr</span> <span class="ow">or</span> <span class="n">_is_slot_attr</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">base_attr_map</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_setattr_with_converter</span><span class="p">(</span>
                    <span class="n">attr_name</span><span class="p">,</span> <span class="n">value_var</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">,</span> <span class="n">converter</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;_inst_dict[&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;] = </span><span class="si">{</span><span class="n">converter</span><span class="o">.</span><span class="n">_fmt_converter_call</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span><span class="w"> </span><span class="n">value_var</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;_inst_dict = self.__dict__&quot;</span><span class="p">,),</span>
            <span class="n">fmt_setter</span><span class="p">,</span>
            <span class="n">fmt_setter_with_converter</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Not frozen -- we can just assign directly.</span>
    <span class="k">return</span> <span class="p">(),</span> <span class="n">_assign</span><span class="p">,</span> <span class="n">_assign_with_converter</span>


<span class="k">def</span> <span class="nf">_attrs_to_init_script</span><span class="p">(</span>
    <span class="n">attrs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Attribute</span><span class="p">],</span>
    <span class="n">is_frozen</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">is_slotted</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">call_pre_init</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">pre_init_has_args</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">call_post_init</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">does_cache_hash</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">base_attr_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">],</span>
    <span class="n">is_exc</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">needs_cached_setattr</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">has_cls_on_setattr</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">method_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a script of an initializer for *attrs*, a dict of globals, and</span>
<span class="sd">    annotations for the initializer.</span>

<span class="sd">    The globals are required by the generated script.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;self.__attrs_pre_init__()&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">call_pre_init</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">needs_cached_setattr</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="c1"># Circumvent the __setattr__ descriptor to save one lookup per</span>
            <span class="c1"># assignment. Note _setattr will be used again below if</span>
            <span class="c1"># does_cache_hash is True.</span>
            <span class="s2">&quot;_setattr = _cached_setattr_get(self)&quot;</span>
        <span class="p">)</span>

    <span class="n">extra_lines</span><span class="p">,</span> <span class="n">fmt_setter</span><span class="p">,</span> <span class="n">fmt_setter_with_converter</span> <span class="o">=</span> <span class="n">_determine_setters</span><span class="p">(</span>
        <span class="n">is_frozen</span><span class="p">,</span> <span class="n">is_slotted</span><span class="p">,</span> <span class="n">base_attr_map</span>
    <span class="p">)</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_lines</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kw_only_args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attrs_to_validate</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># This is a dictionary of names to validator and converter callables.</span>
    <span class="c1"># Injecting this into __init__ globals lets us avoid lookups.</span>
    <span class="n">names_for_globals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">validator</span><span class="p">:</span>
            <span class="n">attrs_to_validate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">attr_name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span>
        <span class="n">has_on_setattr</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">on_setattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">a</span><span class="o">.</span><span class="n">on_setattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">setters</span><span class="o">.</span><span class="n">NO_OP</span> <span class="ow">and</span> <span class="n">has_cls_on_setattr</span>
        <span class="p">)</span>
        <span class="c1"># a.alias is set to maybe-mangled attr_name in _ClassBuilder if not</span>
        <span class="c1"># explicitly provided</span>
        <span class="n">arg_name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">alias</span>

        <span class="n">has_factory</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">Factory</span><span class="p">)</span>
        <span class="n">maybe_self</span> <span class="o">=</span> <span class="s2">&quot;self&quot;</span> <span class="k">if</span> <span class="n">has_factory</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">takes_self</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">converter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">converter</span><span class="p">,</span> <span class="n">Converter</span><span class="p">):</span>
            <span class="n">converter</span> <span class="o">=</span> <span class="n">Converter</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">converter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">converter</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">converter</span>

        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">init</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_factory</span><span class="p">:</span>
                <span class="n">init_factory_name</span> <span class="o">=</span> <span class="n">_INIT_FACTORY_PAT</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
                <span class="k">if</span> <span class="n">converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">fmt_setter_with_converter</span><span class="p">(</span>
                            <span class="n">attr_name</span><span class="p">,</span>
                            <span class="n">init_factory_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">maybe_self</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                            <span class="n">has_on_setattr</span><span class="p">,</span>
                            <span class="n">converter</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">names_for_globals</span><span class="p">[</span><span class="n">converter</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">converter</span><span class="o">.</span><span class="n">converter</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">fmt_setter</span><span class="p">(</span>
                            <span class="n">attr_name</span><span class="p">,</span>
                            <span class="n">init_factory_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">maybe_self</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                            <span class="n">has_on_setattr</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">names_for_globals</span><span class="p">[</span><span class="n">init_factory_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">factory</span>
            <span class="k">elif</span> <span class="n">converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">fmt_setter_with_converter</span><span class="p">(</span>
                        <span class="n">attr_name</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;attr_dict[&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;].default&quot;</span><span class="p">,</span>
                        <span class="n">has_on_setattr</span><span class="p">,</span>
                        <span class="n">converter</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">names_for_globals</span><span class="p">[</span><span class="n">converter</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">converter</span><span class="o">.</span><span class="n">converter</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">fmt_setter</span><span class="p">(</span>
                        <span class="n">attr_name</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;attr_dict[&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;].default&quot;</span><span class="p">,</span>
                        <span class="n">has_on_setattr</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTHING</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_factory</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">=attr_dict[&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;].default&quot;</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">kw_only</span><span class="p">:</span>
                <span class="n">kw_only_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">fmt_setter_with_converter</span><span class="p">(</span>
                        <span class="n">attr_name</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">,</span> <span class="n">converter</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">names_for_globals</span><span class="p">[</span><span class="n">converter</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">converter</span><span class="o">.</span><span class="n">converter</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt_setter</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">has_factory</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2">=NOTHING&quot;</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">kw_only</span><span class="p">:</span>
                <span class="n">kw_only_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;if </span><span class="si">{</span><span class="n">arg_name</span><span class="si">}</span><span class="s2"> is not NOTHING:&quot;</span><span class="p">)</span>

            <span class="n">init_factory_name</span> <span class="o">=</span> <span class="n">_INIT_FACTORY_PAT</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
            <span class="k">if</span> <span class="n">converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;    &quot;</span>
                    <span class="o">+</span> <span class="n">fmt_setter_with_converter</span><span class="p">(</span>
                        <span class="n">attr_name</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">,</span> <span class="n">converter</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;    &quot;</span>
                    <span class="o">+</span> <span class="n">fmt_setter_with_converter</span><span class="p">(</span>
                        <span class="n">attr_name</span><span class="p">,</span>
                        <span class="n">init_factory_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">maybe_self</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                        <span class="n">has_on_setattr</span><span class="p">,</span>
                        <span class="n">converter</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">names_for_globals</span><span class="p">[</span><span class="n">converter</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">converter</span><span class="o">.</span><span class="n">converter</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="n">fmt_setter</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;else:&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;    &quot;</span>
                    <span class="o">+</span> <span class="n">fmt_setter</span><span class="p">(</span>
                        <span class="n">attr_name</span><span class="p">,</span>
                        <span class="n">init_factory_name</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="n">maybe_self</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
                        <span class="n">has_on_setattr</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">names_for_globals</span><span class="p">[</span><span class="n">init_factory_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">factory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">kw_only</span><span class="p">:</span>
                <span class="n">kw_only_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">fmt_setter_with_converter</span><span class="p">(</span>
                        <span class="n">attr_name</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">,</span> <span class="n">converter</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">names_for_globals</span><span class="p">[</span><span class="n">converter</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">converter</span><span class="o">.</span><span class="n">converter</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fmt_setter</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">has_on_setattr</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">init</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">converter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">annotations</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">type</span>
            <span class="k">elif</span> <span class="n">converter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">converter</span><span class="o">.</span><span class="n">_first_param_type</span><span class="p">:</span>
                <span class="c1"># Use the type from the converter if present.</span>
                <span class="n">annotations</span><span class="p">[</span><span class="n">arg_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">converter</span><span class="o">.</span><span class="n">_first_param_type</span>

    <span class="k">if</span> <span class="n">attrs_to_validate</span><span class="p">:</span>  <span class="c1"># we can skip this if there are no validators.</span>
        <span class="n">names_for_globals</span><span class="p">[</span><span class="s2">&quot;_config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_config</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;if _config._run_validators is True:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs_to_validate</span><span class="p">:</span>
            <span class="n">val_name</span> <span class="o">=</span> <span class="s2">&quot;__attr_validator_&quot;</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span>
            <span class="n">attr_name</span> <span class="o">=</span> <span class="s2">&quot;__attr_&quot;</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">val_name</span><span class="si">}</span><span class="s2">(self, </span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">, self.</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">names_for_globals</span><span class="p">[</span><span class="n">val_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">validator</span>
            <span class="n">names_for_globals</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>

    <span class="k">if</span> <span class="n">call_post_init</span><span class="p">:</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;self.__attrs_post_init__()&quot;</span><span class="p">)</span>

    <span class="c1"># Because this is set only after __attrs_post_init__ is called, a crash</span>
    <span class="c1"># will result if post-init tries to access the hash code.  This seemed</span>
    <span class="c1"># preferable to setting this beforehand, in which case alteration to field</span>
    <span class="c1"># values during post-init combined with post-init accessing the hash code</span>
    <span class="c1"># would result in silent bugs.</span>
    <span class="k">if</span> <span class="n">does_cache_hash</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_frozen</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_slotted</span><span class="p">:</span>
                <span class="n">init_hash_cache</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_setattr(&#39;</span><span class="si">{</span><span class="n">_HASH_CACHE_FIELD</span><span class="si">}</span><span class="s2">&#39;, None)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">init_hash_cache</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_inst_dict[&#39;</span><span class="si">{</span><span class="n">_HASH_CACHE_FIELD</span><span class="si">}</span><span class="s2">&#39;] = None&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">init_hash_cache</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">_HASH_CACHE_FIELD</span><span class="si">}</span><span class="s2"> = None&quot;</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">init_hash_cache</span><span class="p">)</span>

    <span class="c1"># For exceptions we rely on BaseException.__init__ for proper</span>
    <span class="c1"># initialization.</span>
    <span class="k">if</span> <span class="n">is_exc</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;self.</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">init</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BaseException.__init__(self, </span><span class="si">{</span><span class="n">vals</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">pre_init_args</span> <span class="o">=</span> <span class="n">args</span>
    <span class="k">if</span> <span class="n">kw_only_args</span><span class="p">:</span>
        <span class="c1"># leading comma &amp; kw_only args</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">*, </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kw_only_args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">pre_init_kw_only_args</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kw_arg_name</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">kw_arg_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="c1"># We need to remove the defaults from the kw_only_args.</span>
                <span class="k">for</span> <span class="n">kw_arg_name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">kwa</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">kwa</span> <span class="ow">in</span> <span class="n">kw_only_args</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">pre_init_args</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span> <span class="k">if</span> <span class="n">pre_init_args</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">pre_init_args</span> <span class="o">+=</span> <span class="n">pre_init_kw_only_args</span>

    <span class="k">if</span> <span class="n">call_pre_init</span> <span class="ow">and</span> <span class="n">pre_init_has_args</span><span class="p">:</span>
        <span class="c1"># If pre init method has arguments, pass same arguments as `__init__`.</span>
        <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;self.__attrs_pre_init__(</span><span class="si">{</span><span class="n">pre_init_args</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="c1"># Python 3.7 doesn&#39;t allow backslashes in f strings.</span>
    <span class="n">NL</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;def </span><span class="si">{</span><span class="n">method_name</span><span class="si">}</span><span class="s2">(self, </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2">):</span>
<span class="s2">    </span><span class="si">{</span><span class="n">NL</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">lines</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;pass&#39;</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">names_for_globals</span><span class="p">,</span>
        <span class="n">annotations</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_default_init_alias_for</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default __init__ parameter name for a field.</span>

<span class="sd">    This performs private-name adjustment via leading-unscore stripping,</span>
<span class="sd">    and is the default value of Attribute.alias if not provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Attribute</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Read-only* representation of an attribute.</span>

<span class="sd">    .. warning::</span>

<span class="sd">       You should never instantiate this class yourself.</span>

<span class="sd">    The class has *all* arguments of `attr.ib` (except for ``factory`` which is</span>
<span class="sd">    only syntactic sugar for ``default=Factory(...)`` plus the following:</span>

<span class="sd">    - ``name`` (`str`): The name of the attribute.</span>
<span class="sd">    - ``alias`` (`str`): The __init__ parameter name of the attribute, after</span>
<span class="sd">      any explicit overrides and default private-attribute-name handling.</span>
<span class="sd">    - ``inherited`` (`bool`): Whether or not that attribute has been inherited</span>
<span class="sd">      from a base class.</span>
<span class="sd">    - ``eq_key`` and ``order_key`` (`typing.Callable` or `None`): The</span>
<span class="sd">      callables that are used for comparing and ordering objects by this</span>
<span class="sd">      attribute, respectively. These are set by passing a callable to</span>
<span class="sd">      `attr.ib`&#39;s ``eq``, ``order``, or ``cmp`` arguments. See also</span>
<span class="sd">      :ref:`comparison customization &lt;custom-comparison&gt;`.</span>

<span class="sd">    Instances of this class are frequently used for introspection purposes</span>
<span class="sd">    like:</span>

<span class="sd">    - `fields` returns a tuple of them.</span>
<span class="sd">    - Validators get them passed as the first argument.</span>
<span class="sd">    - The :ref:`field transformer &lt;transform-fields&gt;` hook receives a list of</span>
<span class="sd">      them.</span>
<span class="sd">    - The ``alias`` property exposes the __init__ parameter name of the field,</span>
<span class="sd">      with any overrides and default private-attribute handling applied.</span>


<span class="sd">    .. versionadded:: 20.1.0 *inherited*</span>
<span class="sd">    .. versionadded:: 20.1.0 *on_setattr*</span>
<span class="sd">    .. versionchanged:: 20.2.0 *inherited* is not taken into account for</span>
<span class="sd">        equality checks and hashing anymore.</span>
<span class="sd">    .. versionadded:: 21.1.0 *eq_key* and *order_key*</span>
<span class="sd">    .. versionadded:: 22.2.0 *alias*</span>

<span class="sd">    For the full version history of the fields, see `attr.ib`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="s2">&quot;validator&quot;</span><span class="p">,</span>
        <span class="s2">&quot;repr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eq_key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;order&quot;</span><span class="p">,</span>
        <span class="s2">&quot;order_key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;init&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;converter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kw_only&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inherited&quot;</span><span class="p">,</span>
        <span class="s2">&quot;on_setattr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;alias&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">default</span><span class="p">,</span>
        <span class="n">validator</span><span class="p">,</span>
        <span class="nb">repr</span><span class="p">,</span>
        <span class="n">cmp</span><span class="p">,</span>  <span class="c1"># XXX: unused, remove along with other cmp code.</span>
        <span class="nb">hash</span><span class="p">,</span>
        <span class="n">init</span><span class="p">,</span>
        <span class="n">inherited</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">converter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">kw_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">eq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eq_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">order_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">on_setattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">alias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">eq</span><span class="p">,</span> <span class="n">eq_key</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">order_key</span> <span class="o">=</span> <span class="n">_determine_attrib_eq_order</span><span class="p">(</span>
            <span class="n">cmp</span><span class="p">,</span> <span class="n">eq_key</span> <span class="ow">or</span> <span class="n">eq</span><span class="p">,</span> <span class="n">order_key</span> <span class="ow">or</span> <span class="n">order</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Cache this descriptor here to speed things up later.</span>
        <span class="n">bound_setattr</span> <span class="o">=</span> <span class="n">_OBJ_SETATTR</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Despite the big red warning, people *do* instantiate `Attribute`</span>
        <span class="c1"># themselves.</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;validator&quot;</span><span class="p">,</span> <span class="n">validator</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;repr&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="n">eq</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;eq_key&quot;</span><span class="p">,</span> <span class="n">eq_key</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;order_key&quot;</span><span class="p">,</span> <span class="n">order_key</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;hash&quot;</span><span class="p">,</span> <span class="nb">hash</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="n">init</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;converter&quot;</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">types</span><span class="o">.</span><span class="n">MappingProxyType</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>  <span class="c1"># Shallow copy</span>
                <span class="k">if</span> <span class="n">metadata</span>
                <span class="k">else</span> <span class="n">_EMPTY_METADATA_SINGLETON</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;kw_only&quot;</span><span class="p">,</span> <span class="n">kw_only</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;inherited&quot;</span><span class="p">,</span> <span class="n">inherited</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;on_setattr&quot;</span><span class="p">,</span> <span class="n">on_setattr</span><span class="p">)</span>
        <span class="n">bound_setattr</span><span class="p">(</span><span class="s2">&quot;alias&quot;</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">FrozenInstanceError</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_counting_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># type holds the annotated value. deal with conflicts:</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">ca</span><span class="o">.</span><span class="n">type</span>
        <span class="k">elif</span> <span class="n">ca</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Type annotation and type argument cannot both be present&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">inst_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Attribute</span><span class="o">.</span><span class="vm">__slots__</span>
            <span class="k">if</span> <span class="n">k</span>
            <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;validator&quot;</span><span class="p">,</span>
                <span class="s2">&quot;default&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;inherited&quot;</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># exclude methods and deprecated alias</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">_validator</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">ca</span><span class="o">.</span><span class="n">_default</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
            <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">inherited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">inst_dict</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Don&#39;t use attrs.evolve since fields(Attribute) doesn&#39;t work</span>
    <span class="k">def</span> <span class="nf">evolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">changes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy *self* and apply *changes*.</span>

<span class="sd">        This works similarly to `attrs.evolve` but that function does not work</span>
<span class="sd">        with {class}`Attribute`.</span>

<span class="sd">        It is mainly meant to be used for `transform-fields`.</span>

<span class="sd">        .. versionadded:: 20.3.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">new</span><span class="o">.</span><span class="n">_setattrs</span><span class="p">(</span><span class="n">changes</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">new</span>

    <span class="c1"># Don&#39;t use _add_pickle since fields(Attribute) doesn&#39;t work</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play nice with pickle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;metadata&quot;</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play nice with pickle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setattrs</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_setattrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_values_pairs</span><span class="p">):</span>
        <span class="n">bound_setattr</span> <span class="o">=</span> <span class="n">_OBJ_SETATTR</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">name_values_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;metadata&quot;</span><span class="p">:</span>
                <span class="n">bound_setattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bound_setattr</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="n">types</span><span class="o">.</span><span class="n">MappingProxyType</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">value</span>
                        <span class="k">else</span> <span class="n">_EMPTY_METADATA_SINGLETON</span>
                    <span class="p">),</span>
                <span class="p">)</span>


<span class="n">_a</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Attribute</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">NOTHING</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">hash</span><span class="o">=</span><span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;metadata&quot;</span><span class="p">),</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">inherited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">alias</span><span class="o">=</span><span class="n">_default_init_alias_for</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">Attribute</span><span class="o">.</span><span class="vm">__slots__</span>
<span class="p">]</span>

<span class="n">Attribute</span> <span class="o">=</span> <span class="n">_add_hash</span><span class="p">(</span>
    <span class="n">_add_eq</span><span class="p">(</span>
        <span class="n">_add_repr</span><span class="p">(</span><span class="n">Attribute</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">_a</span><span class="p">),</span>
        <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_a</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;inherited&quot;</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">_a</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">hash</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;inherited&quot;</span><span class="p">],</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">_CountingAttr</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intermediate representation of attributes that uses a counter to preserve</span>
<span class="sd">    the order in which the attributes have been defined.</span>

<span class="sd">    *Internal* data structure of the attrs library.  Running into is most</span>
<span class="sd">    likely the result of a bug like a forgotten `@attr.s` decorator.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;counter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_default&quot;</span><span class="p">,</span>
        <span class="s2">&quot;repr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eq_key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;order&quot;</span><span class="p">,</span>
        <span class="s2">&quot;order_key&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;init&quot;</span><span class="p">,</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_validator&quot;</span><span class="p">,</span>
        <span class="s2">&quot;converter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;kw_only&quot;</span><span class="p">,</span>
        <span class="s2">&quot;on_setattr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;alias&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">__attrs_attrs__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">*</span><span class="nb">tuple</span><span class="p">(</span>
            <span class="n">Attribute</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">alias</span><span class="o">=</span><span class="n">_default_init_alias_for</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                <span class="n">default</span><span class="o">=</span><span class="n">NOTHING</span><span class="p">,</span>
                <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">kw_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">eq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">eq_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">order_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">inherited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">on_setattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;counter&quot;</span><span class="p">,</span>
                <span class="s2">&quot;_default&quot;</span><span class="p">,</span>
                <span class="s2">&quot;repr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
                <span class="s2">&quot;order&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hash&quot;</span><span class="p">,</span>
                <span class="s2">&quot;init&quot;</span><span class="p">,</span>
                <span class="s2">&quot;on_setattr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;alias&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">Attribute</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
            <span class="n">alias</span><span class="o">=</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="nb">hash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">kw_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">eq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">eq_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">order_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">inherited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">on_setattr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">cls_counter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">default</span><span class="p">,</span>
        <span class="n">validator</span><span class="p">,</span>
        <span class="nb">repr</span><span class="p">,</span>
        <span class="n">cmp</span><span class="p">,</span>
        <span class="nb">hash</span><span class="p">,</span>
        <span class="n">init</span><span class="p">,</span>
        <span class="n">converter</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">,</span>
        <span class="n">kw_only</span><span class="p">,</span>
        <span class="n">eq</span><span class="p">,</span>
        <span class="n">eq_key</span><span class="p">,</span>
        <span class="n">order</span><span class="p">,</span>
        <span class="n">order_key</span><span class="p">,</span>
        <span class="n">on_setattr</span><span class="p">,</span>
        <span class="n">alias</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">_CountingAttr</span><span class="o">.</span><span class="n">cls_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">_CountingAttr</span><span class="o">.</span><span class="n">cls_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="n">validator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">converter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repr</span> <span class="o">=</span> <span class="nb">repr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eq</span> <span class="o">=</span> <span class="n">eq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eq_key</span> <span class="o">=</span> <span class="n">eq_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_key</span> <span class="o">=</span> <span class="n">order_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hash</span> <span class="o">=</span> <span class="nb">hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kw_only</span> <span class="o">=</span> <span class="n">kw_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_setattr</span> <span class="o">=</span> <span class="n">on_setattr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span>

    <span class="k">def</span> <span class="nf">validator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decorator that adds *meth* to the list of validators.</span>

<span class="sd">        Returns *meth* unchanged.</span>

<span class="sd">        .. versionadded:: 17.1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="n">meth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validator</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_validator</span><span class="p">,</span> <span class="n">meth</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">meth</span>

    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Decorator that allows to set the default for an attribute.</span>

<span class="sd">        Returns *meth* unchanged.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DefaultAlreadySetError: If default has been set before.</span>

<span class="sd">        .. versionadded:: 17.1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTHING</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DefaultAlreadySetError</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">(</span><span class="n">meth</span><span class="p">,</span> <span class="n">takes_self</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">meth</span>


<span class="n">_CountingAttr</span> <span class="o">=</span> <span class="n">_add_eq</span><span class="p">(</span><span class="n">_add_repr</span><span class="p">(</span><span class="n">_CountingAttr</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Factory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores a factory callable.</span>

<span class="sd">    If passed as the default value to `attrs.field`, the factory is used to</span>
<span class="sd">    generate a new value.</span>

<span class="sd">    Args:</span>
<span class="sd">        factory (typing.Callable):</span>
<span class="sd">            A callable that takes either none or exactly one mandatory</span>
<span class="sd">            positional argument depending on *takes_self*.</span>

<span class="sd">        takes_self (bool):</span>
<span class="sd">            Pass the partially initialized instance that is being initialized</span>
<span class="sd">            as a positional argument.</span>

<span class="sd">    .. versionadded:: 17.1.0  *takes_self*</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;factory&quot;</span><span class="p">,</span> <span class="s2">&quot;takes_self&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">takes_self</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span> <span class="o">=</span> <span class="n">factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span> <span class="o">=</span> <span class="n">takes_self</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play nice with pickle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Play nice with pickle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="n">_f</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Attribute</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">NOTHING</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">inherited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">Factory</span><span class="o">.</span><span class="vm">__slots__</span>
<span class="p">]</span>

<span class="n">Factory</span> <span class="o">=</span> <span class="n">_add_hash</span><span class="p">(</span><span class="n">_add_eq</span><span class="p">(</span><span class="n">_add_repr</span><span class="p">(</span><span class="n">Factory</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">_f</span><span class="p">),</span> <span class="n">attrs</span><span class="o">=</span><span class="n">_f</span><span class="p">),</span> <span class="n">attrs</span><span class="o">=</span><span class="n">_f</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Converter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores a converter callable.</span>

<span class="sd">    Allows for the wrapped converter to take additional arguments. The</span>
<span class="sd">    arguments are passed in the order they are documented.</span>

<span class="sd">    Args:</span>
<span class="sd">        converter (Callable): A callable that converts the passed value.</span>

<span class="sd">        takes_self (bool):</span>
<span class="sd">            Pass the partially initialized instance that is being initialized</span>
<span class="sd">            as a positional argument. (default: `False`)</span>

<span class="sd">        takes_field (bool):</span>
<span class="sd">            Pass the field definition (an :class:`Attribute`) into the</span>
<span class="sd">            converter as a positional argument. (default: `False`)</span>

<span class="sd">    .. versionadded:: 24.1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;converter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;takes_self&quot;</span><span class="p">,</span>
        <span class="s2">&quot;takes_field&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_first_param_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_global_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__call__&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">takes_self</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">takes_field</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">converter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span> <span class="o">=</span> <span class="n">takes_self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">takes_field</span> <span class="o">=</span> <span class="n">takes_field</span>

        <span class="n">ex</span> <span class="o">=</span> <span class="n">_AnnotationExtractor</span><span class="p">(</span><span class="n">converter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_param_type</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">get_first_param_type</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_field</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_field</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">__</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">instance</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_field</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">field</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">(</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">field</span>
            <span class="p">)</span>

        <span class="n">rt</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">get_return_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__call__</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">[</span><span class="s2">&quot;return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_global_name</span><span class="p">(</span><span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the name that a converter for an attribute name *attr_name*</span>
<span class="sd">        would have.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;__attr_converter_</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_fmt_converter_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a string that calls the converter for an attribute name</span>
<span class="sd">        *attr_name* and the value in variable named *value_var* according to</span>
<span class="sd">        `self.takes_self` and `self.takes_field`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_field</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_field</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">, self, attr_dict[&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;])&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">, self)&quot;</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_global_name</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">, attr_dict[&#39;</span><span class="si">{</span><span class="n">attr_name</span><span class="si">}</span><span class="s2">&#39;])&quot;</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dict containing only converter and takes_self -- the rest gets</span>
<span class="sd">        computed when loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;converter&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">converter</span><span class="p">,</span>
            <span class="s2">&quot;takes_self&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_self</span><span class="p">,</span>
            <span class="s2">&quot;takes_field&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">takes_field</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load instance from state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">state</span><span class="p">)</span>


<span class="n">_f</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Attribute</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">NOTHING</span><span class="p">,</span>
        <span class="n">validator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">cmp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">eq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">hash</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">inherited</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;converter&quot;</span><span class="p">,</span> <span class="s2">&quot;takes_self&quot;</span><span class="p">,</span> <span class="s2">&quot;takes_field&quot;</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">Converter</span> <span class="o">=</span> <span class="n">_add_hash</span><span class="p">(</span>
    <span class="n">_add_eq</span><span class="p">(</span><span class="n">_add_repr</span><span class="p">(</span><span class="n">Converter</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="n">_f</span><span class="p">),</span> <span class="n">attrs</span><span class="o">=</span><span class="n">_f</span><span class="p">),</span> <span class="n">attrs</span><span class="o">=</span><span class="n">_f</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">make_class</span><span class="p">(</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">bases</span><span class="o">=</span><span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="n">class_body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes_arguments</span>
<span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A quick way to create a new class called *name* with *attrs*.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name for the new class.</span>

<span class="sd">        attrs( list | dict):</span>
<span class="sd">            A list of names or a dictionary of mappings of names to `attr.ib`\</span>
<span class="sd">            s / `attrs.field`\ s.</span>

<span class="sd">            The order is deduced from the order of the names or attributes</span>
<span class="sd">            inside *attrs*.  Otherwise the order of the definition of the</span>
<span class="sd">            attributes is used.</span>

<span class="sd">        bases (tuple[type, ...]): Classes that the new class will subclass.</span>

<span class="sd">        class_body (dict):</span>
<span class="sd">            An optional dictionary of class attributes for the new class.</span>

<span class="sd">        attributes_arguments: Passed unmodified to `attr.s`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        type: A new class with *attrs*.</span>

<span class="sd">    .. versionadded:: 17.1.0 *bases*</span>
<span class="sd">    .. versionchanged:: 18.1.0 If *attrs* is ordered, the order is retained.</span>
<span class="sd">    .. versionchanged:: 23.2.0 *class_body*</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">cls_dict</span> <span class="o">=</span> <span class="n">attrs</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">cls_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">attrib</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;attrs argument must be a dict or a list.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">pre_init</span> <span class="o">=</span> <span class="n">cls_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__attrs_pre_init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">post_init</span> <span class="o">=</span> <span class="n">cls_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__attrs_post_init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">user_init</span> <span class="o">=</span> <span class="n">cls_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">body</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">class_body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">body</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">class_body</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pre_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">body</span><span class="p">[</span><span class="s2">&quot;__attrs_pre_init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre_init</span>
    <span class="k">if</span> <span class="n">post_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">body</span><span class="p">[</span><span class="s2">&quot;__attrs_post_init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_init</span>
    <span class="k">if</span> <span class="n">user_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">body</span><span class="p">[</span><span class="s2">&quot;__init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user_init</span>

    <span class="n">type_</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">new_class</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="p">{},</span> <span class="k">lambda</span> <span class="n">ns</span><span class="p">:</span> <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>

    <span class="c1"># For pickling to work, the __module__ variable needs to be set to the</span>
    <span class="c1"># frame where the class is created.  Bypass this step in environments where</span>
    <span class="c1"># sys._getframe is not defined (Jython for example) or sys._getframe is not</span>
    <span class="c1"># defined for arguments greater than 0 (IronPython).</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">type_</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">f_globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;__main__&quot;</span>
        <span class="p">)</span>

    <span class="c1"># We do it here for proper warnings with meaningful stacklevel.</span>
    <span class="n">cmp</span> <span class="o">=</span> <span class="n">attributes_arguments</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cmp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">(</span>
        <span class="n">attributes_arguments</span><span class="p">[</span><span class="s2">&quot;eq&quot;</span><span class="p">],</span>
        <span class="n">attributes_arguments</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">_determine_attrs_eq_order</span><span class="p">(</span>
        <span class="n">cmp</span><span class="p">,</span>
        <span class="n">attributes_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eq&quot;</span><span class="p">),</span>
        <span class="n">attributes_arguments</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">),</span>
        <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="bp">cls</span> <span class="o">=</span> <span class="n">_attrs</span><span class="p">(</span><span class="n">these</span><span class="o">=</span><span class="n">cls_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes_arguments</span><span class="p">)(</span><span class="n">type_</span><span class="p">)</span>
    <span class="c1"># Only add type annotations now or &quot;_attrs()&quot; will complain:</span>
    <span class="bp">cls</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cls_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="bp">cls</span>


<span class="c1"># These are required by within this module so we define them here and merely</span>
<span class="c1"># import into .validators / .converters.</span>


<span class="nd">@attrs</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unsafe_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">_AndValidator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compose many validators to a single one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_validators</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validators</span><span class="p">:</span>
            <span class="n">v</span><span class="p">(</span><span class="n">inst</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">and_</span><span class="p">(</span><span class="o">*</span><span class="n">validators</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A validator that composes multiple validators into one.</span>

<span class="sd">    When called on a value, it runs all wrapped validators.</span>

<span class="sd">    Args:</span>
<span class="sd">        validators (~collections.abc.Iterable[typing.Callable]):</span>
<span class="sd">            Arbitrary number of validators.</span>

<span class="sd">    .. versionadded:: 17.1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">validator</span> <span class="ow">in</span> <span class="n">validators</span><span class="p">:</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="n">validator</span><span class="o">.</span><span class="n">_validators</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">validator</span><span class="p">,</span> <span class="n">_AndValidator</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">[</span><span class="n">validator</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">_AndValidator</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">pipe</span><span class="p">(</span><span class="o">*</span><span class="n">converters</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A converter that composes multiple converters into one.</span>

<span class="sd">    When called on a value, it runs all wrapped converters, returning the</span>
<span class="sd">    *last* value.</span>

<span class="sd">    Type annotations will be inferred from the wrapped converters&#39;, if they</span>
<span class="sd">    have any.</span>

<span class="sd">        converters (~collections.abc.Iterable[typing.Callable]):</span>
<span class="sd">            Arbitrary number of converters.</span>

<span class="sd">    .. versionadded:: 20.1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">pipe_converter</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">converters</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">inst</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Converter</span><span class="p">)</span> <span class="k">else</span> <span class="n">c</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">val</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">converters</span><span class="p">:</span>
        <span class="c1"># If the converter list is empty, pipe_converter is the identity.</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">)</span>
        <span class="n">pipe_converter</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="s2">&quot;return&quot;</span><span class="p">:</span> <span class="n">A</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get parameter type from first converter.</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">_AnnotationExtractor</span><span class="p">(</span><span class="n">converters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">get_first_param_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">pipe_converter</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

        <span class="n">last</span> <span class="o">=</span> <span class="n">converters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">PY_3_11_PLUS</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">Converter</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="fm">__call__</span>

        <span class="c1"># Get return type from last converter.</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">_AnnotationExtractor</span><span class="p">(</span><span class="n">last</span><span class="p">)</span><span class="o">.</span><span class="n">get_return_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rt</span><span class="p">:</span>
            <span class="n">pipe_converter</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">[</span><span class="s2">&quot;return&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt</span>

    <span class="k">return</span> <span class="n">Converter</span><span class="p">(</span><span class="n">pipe_converter</span><span class="p">,</span> <span class="n">takes_self</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">takes_field</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>